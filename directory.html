<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å¹³å°é€šè¨ŠéŒ„ | Platform Directory - UVACO</title>
<link rel="stylesheet" href="styles.css">
<!-- Supabase JSï¼ˆCDNï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="cloud.js?v=20251231"></script>
<style>
  /* æˆ‘çš„åç‰‡ï¼ˆé›²ç«¯ï¼‰ */
  .my-card-panel {
    margin: 14px 0 12px;
    padding: 14px 14px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(22,22,24,0.75);
    backdrop-filter: blur(14px);
    box-shadow: 0 10px 24px rgba(0,0,0,0.35);
  }
  body.theme-light .my-card-panel {
    background: rgba(255,255,255,0.92);
    border-color: rgba(15,23,42,0.08);
    box-shadow: 0 10px 24px rgba(15,23,42,0.12);
  }
  .my-card-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 800;
    margin-bottom: 8px;
    color: var(--uvaco-green);
  }
  .my-card-kv {
    display: grid;
    grid-template-columns: 84px 1fr;
    gap: 6px 10px;
    font-size: 14px;
    line-height: 1.5;
  }
  .my-card-k {
    opacity: 0.75;
    font-weight: 700;
  }
  .my-card-v {
    opacity: 0.95;
    word-break: break-word;
  }
  .my-card-actions {
    display: flex;
    gap: 10px;
    margin-top: 12px;
  }
  .my-card-actions a {
    text-decoration: none;
  }
</style>
</head>

<body class="theme-dark lang-zh">

<!-- èƒŒæ™¯æ³¡æ³¡ -->
<div class="bg-blob blob1"></div>
<div class="bg-blob blob2"></div>

<!-- å¹³å°é€šè¨ŠéŒ„é é¢ -->
<div class="directory-page">
  <!-- é ‚éƒ¨æ¨™é¡Œæ¬„ -->
  <div class="directory-header">
    <a href="yuyuko.html" class="directory-back-btn">â†</a>
    <h1 class="directory-title lang-zh">å¹³å°é€šè¨ŠéŒ„</h1>
    <h1 class="directory-title lang-en">Platform Directory</h1>
    <button class="directory-add-friend-btn" onclick="openAddFriendModal()">
      <span class="lang-zh">+ æ–°å¢å¥½å‹</span>
      <span class="lang-en">+ Add Friend</span>
    </button>
  </div>
  
  <!-- æœå°‹æ¬„å®¹å™¨ï¼ˆç§»åˆ°å…§å®¹å€åŸŸå¤–ï¼Œå› ç‚ºæ˜¯å›ºå®šå®šä½ï¼‰ -->
  <div class="directory-search-wrapper">
    <input 
      type="text" 
      class="directory-search" 
      id="directorySearchInput"
      data-placeholder-zh="æœå°‹å…¬å¸ã€å§“åã€è·å‹™ã€é¡åˆ¥ã€åœ°å€..."
      data-placeholder-en="Search company, name, position, category, region..."
      placeholder="æœå°‹å…¬å¸ã€å§“åã€è·å‹™ã€é¡åˆ¥ã€åœ°å€..."
      onkeyup="handleDirectorySearch(event)"
      onclick="showSearchOptions()"
      onfocus="showSearchOptions()"
    >
    
    <!-- æœå°‹é¸é …å½ˆå‡ºè¦–çª— -->
    <div class="directory-search-options" id="directorySearchOptions">
      <button class="directory-search-option-btn" onclick="openAdvancedFilter()">
        <span class="lang-zh">é€²éš</span>
        <span class="lang-en">Advanced</span>
      </button>
    </div>
  </div>
  
  <!-- å…§å®¹å€åŸŸ -->
  <div class="directory-content">
    <!-- é€²éšç¯©é¸é¢æ¿ -->
    <div class="directory-filter-panel" id="directoryFilterPanel">
      <div class="directory-filter-group">
        <label class="directory-filter-label lang-zh">é¡åˆ¥</label>
        <label class="directory-filter-label lang-en">Category</label>
        <!-- é¡åˆ¥å…©å±¤å¼é¸æ“‡å™¨ï¼ˆModal/Bottom Sheet å¼•å°ï¼šå¤§é¡ â†’ ç´°é …ï¼‰ -->
        <input
          type="text"
          class="directory-filter-select two-level-picker-trigger"
          id="filterCategoryDisplay"
          readonly
          data-placeholder-zh="é¸æ“‡é¡åˆ¥ï¼ˆå¤§é¡ / ç´°é …ï¼‰"
          data-placeholder-en="Select category (Category / Subcategory)"
          placeholder="é¸æ“‡é¡åˆ¥ï¼ˆå¤§é¡ / ç´°é …ï¼‰"
          onclick="openTwoLevelPicker('category', 'filter')"
        >
        <!-- å…¼å®¹ï¼šä¿ç•™åŸæœ¬çš„å€¼æ¬„ä½ï¼ˆä¸å†ç”¨ select é¡¯ç¤ºï¼‰ -->
        <input type="hidden" id="filterCategory" value="">
      </div>
      
      <div class="directory-filter-group">
        <label class="directory-filter-label lang-zh">åœ°å€</label>
        <label class="directory-filter-label lang-en">Region</label>
        <!-- åœ°å€ä¸‰å±¤å¼é¸æ“‡å™¨ï¼ˆModal/Bottom Sheet å¼•å°ï¼šå€åŸŸ â†’ ç¸£å¸‚ â†’ å€ï¼‰ -->
        <input
          type="text"
          class="directory-filter-select region-picker-trigger"
          id="filterRegionDisplay"
          readonly
          data-placeholder-zh="é¸æ“‡åœ°å€ï¼ˆå€åŸŸ / ç¸£å¸‚ / å€ï¼‰"
          data-placeholder-en="Select region (Area / City / District)"
          placeholder="é¸æ“‡åœ°å€ï¼ˆå€åŸŸ / ç¸£å¸‚ / å€ï¼‰"
          onclick="openRegionPicker('filter')"
        >
        <!-- å…¼å®¹ï¼šä¿ç•™åŸæœ¬çš„å€¼æ¬„ä½ï¼ˆä¸å†ç”¨ select é¡¯ç¤ºï¼‰ -->
        <input type="hidden" id="filterRegionZone" value="">
        <input type="hidden" id="filterRegionCity" value="">
        <input type="hidden" id="filterRegionDistrict" value="">
      </div>
      
      <div class="directory-filter-group">
        <label class="directory-filter-label lang-zh">å°ˆæ¥­é ˜åŸŸ</label>
        <label class="directory-filter-label lang-en">Professional Field</label>
        <!-- å°ˆæ¥­é ˜åŸŸå…©å±¤å¼é¸æ“‡å™¨ï¼ˆModal/Bottom Sheet å¼•å°ï¼šå¤§é¡ â†’ ç´°é …ï¼‰ -->
        <input
          type="text"
          class="directory-filter-select two-level-picker-trigger"
          id="filterFieldDisplay"
          readonly
          data-placeholder-zh="é¸æ“‡å°ˆæ¥­é ˜åŸŸï¼ˆå¤§é¡ / ç´°é …ï¼‰"
          data-placeholder-en="Select field (Category / Subcategory)"
          placeholder="é¸æ“‡å°ˆæ¥­é ˜åŸŸï¼ˆå¤§é¡ / ç´°é …ï¼‰"
          onclick="openTwoLevelPicker('field', 'filter')"
        >
        <!-- å…¼å®¹ï¼šä¿ç•™åŸæœ¬çš„å€¼æ¬„ä½ï¼ˆä¸å†ç”¨ select é¡¯ç¤ºï¼‰ -->
        <input type="hidden" id="filterField" value="">
      </div>
      
      <div class="directory-filter-group">
        <label class="directory-filter-label lang-zh">å…¬å¸</label>
        <label class="directory-filter-label lang-en">Company</label>
        <select class="directory-filter-select" id="filterCompany" data-lang-zh="å…¨éƒ¨å…¬å¸" data-lang-en="All Companies">
          <option value="" data-lang-zh="å…¨éƒ¨å…¬å¸" data-lang-en="All Companies"></option>
          <!-- é¸é …ç”± JS ç”¢ç”Ÿï¼ˆå®Œæ•´ç´¢å¼•ï¼šæœƒè‡ªå‹•ç´¯ç©ä½ æ–°å¢å¥½å‹çš„å…¬å¸ï¼‰ -->
        </select>
      </div>
      
      <div class="directory-filter-actions">
        <button class="directory-filter-btn directory-filter-btn-clear" onclick="clearDirectoryFilters()">
          <span class="lang-zh">æ¸…é™¤ç¯©é¸</span>
          <span class="lang-en">Clear Filters</span>
        </button>
        <button class="directory-filter-btn directory-filter-btn-apply" onclick="applyDirectoryFilters()">
          <span class="lang-zh">å¥—ç”¨ç¯©é¸</span>
          <span class="lang-en">Apply Filters</span>
        </button>
      </div>
    </div>

    <!-- æˆ‘çš„åç‰‡ï¼ˆé›²ç«¯ï¼šç™»å…¥å¾Œé¡¯ç¤ºï¼‰ -->
    <div class="my-card-panel" id="myCardPanel" style="display:none;">
      <div class="my-card-title">
        <span>ğŸªª</span>
        <span class="lang-zh">æˆ‘çš„åç‰‡</span>
        <span class="lang-en">My Card</span>
      </div>
      <div class="my-card-kv">
        <div class="my-card-k lang-zh">å§“å</div>
        <div class="my-card-k lang-en">Name</div>
        <div class="my-card-v">
          <span class="lang-zh" id="myCardNameZh"></span>
          <span class="lang-en" id="myCardNameEn"></span>
        </div>

        <div class="my-card-k lang-zh">è·å‹™</div>
        <div class="my-card-k lang-en">Title</div>
        <div class="my-card-v">
          <span class="lang-zh" id="myCardTitleZh"></span>
          <span class="lang-en" id="myCardTitleEn"></span>
        </div>

        <div class="my-card-k lang-zh">å…¬å¸</div>
        <div class="my-card-k lang-en">Company</div>
        <div class="my-card-v">
          <span class="lang-zh" id="myCardCompanyZh"></span>
          <span class="lang-en" id="myCardCompanyEn"></span>
        </div>

        <div class="my-card-k">Email</div>
        <div class="my-card-v" id="myCardEmail"></div>
      </div>
      <div class="my-card-actions">
        <a class="btn btn-secondary lang-zh" href="edit.html">âœï¸ ç·¨è¼¯åç‰‡</a>
        <a class="btn btn-secondary lang-en" href="edit.html">âœï¸ Edit Card</a>
        <a class="btn btn-secondary lang-zh" href="yuyuko.html?v=1e6be8e" target="_blank" rel="noopener noreferrer">ğŸ‘€ é è¦½</a>
        <a class="btn btn-secondary lang-en" href="yuyuko.html?v=1e6be8e" target="_blank" rel="noopener noreferrer">ğŸ‘€ Preview</a>
      </div>
    </div>
    
    <!-- çµæœæ¨™é¡Œ -->
    <div class="directory-results-header">
      <span class="lang-zh">æ‰¾åˆ° <span class="directory-results-count" id="directoryResultsCount">0</span> ç­†çµæœ</span>
      <span class="lang-en">Found <span class="directory-results-count" id="directoryResultsCountEn">0</span> results</span>
    </div>
    
    <!-- çµæœåˆ—è¡¨ï¼ˆç›®å‰ç‚ºç©ºç‹€æ…‹ï¼‰ -->
    <div class="directory-empty-state" id="directoryResults">
      <div class="directory-empty-icon">ğŸ”</div>
      <div class="directory-empty-text lang-zh">
        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åç‰‡<br>
        è«‹å˜—è©¦èª¿æ•´æœå°‹é—œéµå­—æˆ–ç¯©é¸æ¢ä»¶
      </div>
      <div class="directory-empty-text lang-en">
        No business cards matching the criteria found.<br>
        Please try adjusting your search keywords or filters.
      </div>
    </div>
  </div>
</div>

<!-- æ–°å¢å¥½å‹æ¨¡æ…‹æ¡† -->
<div class="add-friend-overlay" id="addFriendOverlay" onclick="closeAddFriendModal(event)">
  <div class="add-friend-modal" onclick="event.stopPropagation()">
    <div class="add-friend-modal-header">
      <h2 class="add-friend-modal-title lang-zh">æ–°å¢å¥½å‹</h2>
      <h2 class="add-friend-modal-title lang-en">Add Friend</h2>
      <button class="add-friend-modal-close" onclick="closeAddFriendModal()">Ã—</button>
    </div>
    
    <div class="add-friend-tabs">
      <button class="add-friend-tab active" onclick="switchAddFriendTab('single')" id="tabSingle">
        <span class="lang-zh">å–®ç­†æ–°å¢</span>
        <span class="lang-en">Single Add</span>
      </button>
      <button class="add-friend-tab" onclick="switchAddFriendTab('batch')" id="tabBatch">
        <span class="lang-zh">åŒ¯å…¥è¯çµ¡äºº</span>
        <span class="lang-en">Import Contacts</span>
      </button>
    </div>
    
    <!-- å–®ç­†æ–°å¢è¡¨å–® -->
    <div class="add-friend-tab-content active" id="tabContentSingle">
      <form class="add-friend-form" onsubmit="submitSingleFriend(event)">
        <div class="add-friend-form-group">
          <label class="add-friend-form-label lang-zh">å§“å *</label>
          <label class="add-friend-form-label lang-en">Name *</label>
          <input type="text" class="add-friend-form-input" id="friendName" required>
        </div>
        
        <div class="add-friend-form-group">
          <label class="add-friend-form-label lang-zh">å…¬å¸</label>
          <label class="add-friend-form-label lang-en">Company</label>
          <input type="text" class="add-friend-form-input" id="friendCompany">
        </div>
        
        <div class="add-friend-form-group">
          <label class="add-friend-form-label lang-zh">è·å‹™</label>
          <label class="add-friend-form-label lang-en">Position</label>
          <input type="text" class="add-friend-form-input" id="friendPosition">
        </div>
        
        <div class="add-friend-form-group">
          <label class="add-friend-form-label lang-zh">é›»è©±</label>
          <label class="add-friend-form-label lang-en">Phone</label>
          <input type="tel" class="add-friend-form-input" id="friendPhone">
        </div>
        
        <div class="add-friend-form-group">
          <label class="add-friend-form-label lang-zh">Email</label>
          <label class="add-friend-form-label lang-en">Email</label>
          <input type="email" class="add-friend-form-input" id="friendEmail">
        </div>
        
        <div class="add-friend-form-group">
          <label class="add-friend-form-label lang-zh">é¡åˆ¥</label>
          <label class="add-friend-form-label lang-en">Category</label>
          <!-- é¡åˆ¥å…©å±¤å¼é¸æ“‡å™¨ï¼ˆModal/Bottom Sheet å¼•å°ï¼šå¤§é¡ â†’ ç´°é …ï¼‰ -->
          <input
            type="text"
            class="add-friend-form-select two-level-picker-trigger"
            id="friendCategoryDisplay"
            readonly
            data-placeholder-zh="é¸æ“‡é¡åˆ¥ï¼ˆå¤§é¡ / ç´°é …ï¼‰"
            data-placeholder-en="Select category (Category / Subcategory)"
            placeholder="é¸æ“‡é¡åˆ¥ï¼ˆå¤§é¡ / ç´°é …ï¼‰"
            onclick="openTwoLevelPicker('category', 'friend')"
          >
          <!-- å…¼å®¹ï¼šä¿ç•™åŸæœ¬çš„å€¼æ¬„ä½ï¼ˆä¸å†ç”¨ select é¡¯ç¤ºï¼‰ -->
          <input type="hidden" id="friendCategory" value="">
        </div>
        
        <div class="add-friend-form-group">
          <label class="add-friend-form-label lang-zh">åœ°å€</label>
          <label class="add-friend-form-label lang-en">Region</label>
          <input
            type="text"
            class="add-friend-form-select region-picker-trigger"
            id="friendRegionDisplay"
            readonly
            data-placeholder-zh="é¸æ“‡åœ°å€ï¼ˆå€åŸŸ / ç¸£å¸‚ / å€ï¼‰"
            data-placeholder-en="Select region (Area / City / District)"
            placeholder="é¸æ“‡åœ°å€ï¼ˆå€åŸŸ / ç¸£å¸‚ / å€ï¼‰"
            onclick="openRegionPicker('friend')"
          >
          <!-- å…¼å®¹ï¼šä¿ç•™åŸæœ¬çš„å€¼æ¬„ä½ï¼ˆä¸å†ç”¨ select é¡¯ç¤ºï¼‰ -->
          <input type="hidden" id="friendRegionZone" value="">
          <input type="hidden" id="friendRegionCity" value="">
          <input type="hidden" id="friendRegionDistrict" value="">
        </div>

        <div class="add-friend-form-group">
          <label class="add-friend-form-label lang-zh">å°ˆæ¥­é ˜åŸŸ</label>
          <label class="add-friend-form-label lang-en">Professional Field</label>
          <!-- å°ˆæ¥­é ˜åŸŸå…©å±¤å¼é¸æ“‡å™¨ï¼ˆModal/Bottom Sheet å¼•å°ï¼šå¤§é¡ â†’ ç´°é …ï¼‰ -->
          <input
            type="text"
            class="add-friend-form-select two-level-picker-trigger"
            id="friendFieldDisplay"
            readonly
            data-placeholder-zh="é¸æ“‡å°ˆæ¥­é ˜åŸŸï¼ˆå¤§é¡ / ç´°é …ï¼‰"
            data-placeholder-en="Select field (Category / Subcategory)"
            placeholder="é¸æ“‡å°ˆæ¥­é ˜åŸŸï¼ˆå¤§é¡ / ç´°é …ï¼‰"
            onclick="openTwoLevelPicker('field', 'friend')"
          >
          <!-- å…¼å®¹ï¼šä¿ç•™åŸæœ¬çš„å€¼æ¬„ä½ï¼ˆä¸å†ç”¨ select é¡¯ç¤ºï¼‰ -->
          <input type="hidden" id="friendField" value="">
        </div>
        
        <div class="add-friend-form-actions">
          <button type="button" class="add-friend-btn add-friend-btn-cancel" onclick="closeAddFriendModal()">
            <span class="lang-zh">å–æ¶ˆ</span>
            <span class="lang-en">Cancel</span>
          </button>
          <button type="submit" class="add-friend-btn add-friend-btn-submit">
            <span class="lang-zh">æ–°å¢</span>
            <span class="lang-en">Add</span>
          </button>
        </div>
      </form>
    </div>
    
    <!-- æ‰¹é‡ä¸Šå‚³ -->
    <div class="add-friend-tab-content" id="tabContentBatch">
      <div class="add-friend-batch-content">
        <div class="add-friend-batch-info">
          <div class="add-friend-batch-icon">ğŸ“¥</div>
          <p class="add-friend-batch-text lang-zh">
            ä¸‹è¼‰ç¯„ä¾‹æª”æ¡ˆï¼Œå¡«å¯«å¾Œä¸Šå‚³å³å¯åŒ¯å…¥è¯çµ¡äººï¼ˆCSVï¼‰
          </p>
          <p class="add-friend-batch-text lang-en">
            Download the sample file, fill it in, and upload to import contacts (CSV)
          </p>
        </div>
        
        <div class="add-friend-batch-download">
          <a href="#" class="add-friend-download-link" onclick="downloadSampleFile(event)">
            <span class="add-friend-download-icon">ğŸ“„</span>
            <div>
              <div class="add-friend-download-title lang-zh">ä¸‹è¼‰ç¯„ä¾‹æª”æ¡ˆ</div>
              <div class="add-friend-download-title lang-en">Download Sample File</div>
              <div class="add-friend-download-subtitle lang-zh">Excel æ ¼å¼ (.xlsx)</div>
              <div class="add-friend-download-subtitle lang-en">Excel Format (.xlsx)</div>
            </div>
          </a>
        </div>
        
        <div class="add-friend-form-group">
          <label class="add-friend-form-label lang-zh">é¸æ“‡æª”æ¡ˆ</label>
          <label class="add-friend-form-label lang-en">Select File</label>
          <div class="add-friend-file-upload">
            <input type="file" class="add-friend-file-input" id="batchFileInput" accept=".xlsx,.xls,.csv" onchange="handleBatchFileSelect(event)">
            <label for="batchFileInput" class="add-friend-file-label">
              <span class="add-friend-file-icon"><img src="file-icon.svg" alt="File" style="width: 32px; height: 32px;"></span>
              <span class="add-friend-file-text lang-zh" id="batchFileName">é¸æ“‡æª”æ¡ˆæˆ–æ‹–æ”¾è‡³æ­¤</span>
              <span class="add-friend-file-text lang-en" id="batchFileNameEn">Choose file or drag here</span>
            </label>
          </div>
        </div>
        
        <div class="add-friend-form-actions">
          <button type="button" class="add-friend-btn add-friend-btn-cancel" onclick="closeAddFriendModal()">
            <span class="lang-zh">å–æ¶ˆ</span>
            <span class="lang-en">Cancel</span>
          </button>
          <button type="button" class="add-friend-btn add-friend-btn-submit" onclick="submitBatchUpload()" id="batchUploadBtn" disabled>
            <span class="lang-zh">åŒ¯å…¥</span>
            <span class="lang-en">Import</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- åœ°å€ä¸‰å±¤å¼é¸æ“‡å™¨ï¼ˆå…±ç”¨ Modal/Bottom Sheetï¼‰ -->
<div class="region-picker-overlay" id="regionPickerOverlay" onclick="closeRegionPicker(event)">
  <div class="region-picker-sheet" onclick="event.stopPropagation()">
    <div class="region-picker-header">
      <button class="region-picker-back" id="regionPickerBackBtn" onclick="regionPickerBack()" aria-label="Back">â†</button>
      <div class="region-picker-title">
        <span class="lang-zh" id="regionPickerTitleZh">é¸æ“‡å€åŸŸ</span>
        <span class="lang-en" id="regionPickerTitleEn">Select Area</span>
      </div>
      <button class="region-picker-close" onclick="closeRegionPicker()" aria-label="Close">Ã—</button>
    </div>

    <div class="region-picker-body">
      <div class="region-picker-list" id="regionPickerList"></div>

      <div class="region-picker-custom" id="regionPickerCustom">
        <div class="region-picker-custom-label lang-zh">è‡ªè¨‚å€åŸŸåç¨±</div>
        <div class="region-picker-custom-label lang-en">Custom area name</div>
        <input type="text" class="region-picker-custom-input" id="regionPickerCustomInput" placeholder="ä¾‹å¦‚ï¼šæµ·å¤–">
        <div class="region-picker-custom-actions">
          <button class="region-picker-btn region-picker-btn-cancel" onclick="regionPickerCancelCustom()">
            <span class="lang-zh">å–æ¶ˆ</span><span class="lang-en">Cancel</span>
          </button>
          <button class="region-picker-btn region-picker-btn-ok" onclick="regionPickerConfirmCustom()">
            <span class="lang-zh">ä¸‹ä¸€æ­¥</span><span class="lang-en">Next</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å…©å±¤å¼é¸æ“‡å™¨ï¼ˆé¡åˆ¥/å°ˆæ¥­é ˜åŸŸå…±ç”¨ Modal/Bottom Sheetï¼‰ -->
<div class="region-picker-overlay" id="twoLevelPickerOverlay" onclick="closeTwoLevelPicker(event)">
  <div class="region-picker-sheet" onclick="event.stopPropagation()">
    <div class="region-picker-header">
      <button class="region-picker-back" id="twoLevelPickerBackBtn" onclick="twoLevelPickerBack()" aria-label="Back">â†</button>
      <div class="region-picker-title">
        <span class="lang-zh" id="twoLevelPickerTitleZh">é¸æ“‡</span>
        <span class="lang-en" id="twoLevelPickerTitleEn">Select</span>
      </div>
      <button class="region-picker-close" onclick="closeTwoLevelPicker()" aria-label="Close">Ã—</button>
    </div>

    <div class="region-picker-body">
      <div class="region-picker-list" id="twoLevelPickerList"></div>

      <div class="region-picker-custom" id="twoLevelPickerCustom">
        <div class="region-picker-custom-label lang-zh">è‡ªè¨‚</div>
        <div class="region-picker-custom-label lang-en">Custom</div>
        <input type="text" class="region-picker-custom-input" id="twoLevelPickerCustomInput" placeholder="è«‹è¼¸å…¥è‡ªè¨‚åç¨±" maxlength="50">
        <div class="region-picker-custom-actions">
          <button class="region-picker-btn region-picker-btn-cancel" onclick="twoLevelPickerCancelCustom()">
            <span class="lang-zh">å–æ¶ˆ</span><span class="lang-en">Cancel</span>
          </button>
          <button class="region-picker-btn region-picker-btn-ok" onclick="twoLevelPickerConfirmCustom()">
            <span class="lang-zh">å®Œæˆ</span><span class="lang-en">Done</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- åº•éƒ¨å°èˆªæ¬„ -->
<nav class="bottom-nav">
  <a href="directory.html" class="nav-item">
    <span class="nav-icon">ğŸ“‹</span>
    <span class="nav-label lang-zh">é€šè¨ŠéŒ„</span>
    <span class="nav-label lang-en">Directory</span>
  </a>
  <a href="settings.html" class="nav-item">
    <span class="nav-icon">âš™ï¸</span>
    <span class="nav-label lang-zh">è¨­å®š</span>
    <span class="nav-label lang-en">Settings</span>
  </a>
</nav>

<script src="common.js"></script>
<script>
// é›²ç«¯ç‰ˆï¼šéœ€è¦ç™»å…¥æ‰å¯ä½¿ç”¨ï¼ˆæœªè¨­å®š Supabase å‰‡ç•¥éï¼‰
(async function () {
  try {
    if (window.UVACO_CLOUD && UVACO_CLOUD.hasConfig()) {
      const here = 'directory.html' + (window.location.search || '');
      const r = await UVACO_CLOUD.requireAuth(here);
      if (!r.ok) return;

      // è‹¥å·²ç™»å…¥ä½†å°šæœªå»ºç«‹åç‰‡ï¼Œæç¤ºå‰å¾€ç·¨è¼¯ï¼ˆä¸å¼·åˆ¶è·³è½‰ï¼Œé¿å…ã€Œå¹³å°ç›®éŒ„ã€å°å‘éŒ¯è¦ºï¼‰
      const my = await UVACO_CLOUD.getMyCard();
      renderMyCardPanel(my.card);
      if (!my.card) {
        const msg = getCurrentLang && getCurrentLang() === 'en'
          ? 'You have not created your business card yet. Go to Edit page now?'
          : 'ä½ å°šæœªå»ºç«‹åç‰‡ï¼Œæ˜¯å¦å‰å¾€ã€Œç·¨è¼¯åç‰‡ã€ï¼Ÿ';
        if (confirm(msg)) {
          window.location.href = 'edit.html?mode=onboarding&next=directory.html';
        }
      }

      // å…¨å¹³å°åç‰‡æœå°‹ï¼ˆç™»å…¥å¾Œå¯æœå°‹æ‰€æœ‰å·²å»ºç«‹åç‰‡çš„äººï¼‰
      await refreshDirectoryResults();
    }
  } catch (e) {}
})();

function getCurrentLang() {
  const zhElements = document.querySelectorAll('.lang-zh');
  return zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
}

function safeText(v) {
  return String(v ?? '').replace(/\s+/g, ' ').trim();
}

function renderMyCardPanel(card) {
  const panel = document.getElementById('myCardPanel');
  if (!panel) return;
  if (!card) {
    panel.style.display = 'none';
    return;
  }

  // profile_jsonï¼šä¿ç•™é›™èªè³‡è¨Šï¼›æ²’æœ‰å°±é€€å› cards çš„æ¬„ä½
  let pj = card.profile_json;
  if (typeof pj === 'string') {
    try { pj = JSON.parse(pj); } catch (e) { pj = null; }
  }
  pj = (pj && typeof pj === 'object') ? pj : {};

  const nameZh = safeText(pj.nameZh) || safeText(card.name);
  const nameEn = safeText(pj.nameEn) || safeText(card.name);
  const titleZh = safeText(pj.titleZh) || safeText(card.title);
  const titleEn = safeText(pj.titleEn) || safeText(card.title);
  const companyZh = safeText(pj.companyZh) || safeText(card.company);
  const companyEn = safeText(pj.companyEn) || safeText(card.company);
  const email = safeText(card.email);

  const set = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val || '-';
  };
  set('myCardNameZh', nameZh);
  set('myCardNameEn', nameEn);
  set('myCardTitleZh', titleZh);
  set('myCardTitleEn', titleEn);
  set('myCardCompanyZh', companyZh);
  set('myCardCompanyEn', companyEn);
  set('myCardEmail', email || '-');

  panel.style.display = 'block';
}

// ===== å¹³å°é€šè¨ŠéŒ„ï¼šå…¨å¹³å°å…¬é–‹æœå°‹ï¼ˆç™»å…¥è€…ï¼‰=====
window.__uvacoDirectoryState = window.__uvacoDirectoryState || {
  rows: [],
  loading: false
};

function escapeHtml(s) {
  return String(s ?? '').replace(/[&<>"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));
}

async function refreshDirectoryResults() {
  if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) return;
  if (window.__uvacoDirectoryState.loading) return;
  window.__uvacoDirectoryState.loading = true;

  const resultsDiv = document.getElementById('directoryResults');
  if (resultsDiv) {
    resultsDiv.innerHTML = `
      <div class="directory-empty-icon">â³</div>
      <div class="directory-empty-text lang-zh">è¼‰å…¥å¹³å°åç‰‡ä¸­â€¦</div>
      <div class="directory-empty-text lang-en">Loading directoryâ€¦</div>
    `;
  }

  try {
    const q = (document.getElementById('directorySearchInput')?.value || '').trim();
    const { rows } = await UVACO_CLOUD.searchCards({ q, limit: 100 });
    window.__uvacoDirectoryState.rows = rows || [];
    renderDirectoryResults(window.__uvacoDirectoryState.rows);
  } catch (e) {
    if (resultsDiv) {
      resultsDiv.innerHTML = `
        <div class="directory-empty-icon">âš ï¸</div>
        <div class="directory-empty-text lang-zh">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦</div>
        <div class="directory-empty-text lang-en">Failed to load. Please try again.</div>
      `;
    }
  } finally {
    window.__uvacoDirectoryState.loading = false;
    // æ›´æ–°èªè¨€é¡¯ç¤ºï¼ˆæ²¿ç”¨ç¾æœ‰é‚è¼¯ï¼‰
    const zhElements = document.querySelectorAll('.lang-zh');
    const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
    document.querySelectorAll('#directoryResults .lang-zh').forEach(el => {
      el.style.display = currentLang === 'zh' ? 'block' : 'none';
    });
    document.querySelectorAll('#directoryResults .lang-en').forEach(el => {
      el.style.display = currentLang === 'en' ? 'block' : 'none';
    });
  }
}

function renderDirectoryResults(rows) {
  const resultsDiv = document.getElementById('directoryResults');
  const list = Array.isArray(rows) ? rows : [];
  updateDirectoryResults(list.length);

  if (!resultsDiv) return;
  if (list.length === 0) {
    // ä¿ç•™åŸç©ºç‹€æ…‹
    updateDirectoryResults(0);
    return;
  }

  const itemsHtml = list.map(r => {
    const name = escapeHtml(r?.name || '');
    const company = escapeHtml(r?.company || '');
    const title = escapeHtml(r?.title || '');
    const uid = encodeURIComponent(r?.user_id || '');
    const previewUrl = `yuyuko.html?v=1e3c412&uid=${uid}`;
    return `
      <div class="directory-card-item" style="display:flex;justify-content:space-between;gap:12px;align-items:center;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);background:rgba(22,22,24,0.65);margin:10px 0;">
        <div style="min-width:0;">
          <div style="font-weight:800;color:#e5e7eb;line-height:1.3;word-break:break-word;">${name || '-'}</div>
          <div style="opacity:.9;color:#cbd5e1;font-size:13px;line-height:1.3;margin-top:2px;word-break:break-word;">
            ${company ? company : ''}${(company && title) ? 'ï½œ' : ''}${title ? title : ''}
          </div>
        </div>
        <div style="flex:0 0 auto;display:flex;gap:8px;">
          <a class="btn btn-secondary lang-zh" href="${previewUrl}" target="_blank" rel="noopener noreferrer">ğŸ‘€ é è¦½</a>
          <a class="btn btn-secondary lang-en" href="${previewUrl}" target="_blank" rel="noopener noreferrer">ğŸ‘€ Preview</a>
        </div>
      </div>
    `;
  }).join('');

  resultsDiv.innerHTML = itemsHtml;
}

// ===== å®Œæ•´ç´¢å¼•ï¼šé¡åˆ¥ / åœ°å€ / å°ˆæ¥­é ˜åŸŸ / å…¬å¸ =====
// - é¡åˆ¥/åœ°å€/å°ˆæ¥­é ˜åŸŸï¼šå›ºå®šå®Œæ•´æ¸…å–®
// - å…¬å¸ï¼šæœƒå¾ã€Œæ–°å¢å¥½å‹ã€çš„ company è‡ªå‹•ç´¯ç©æˆç´¢å¼•ï¼ˆè¶Šç”¨è¶Šå®Œæ•´ï¼‰

// ===== é¡åˆ¥å…©å±¤å¼è³‡æ–™çµæ§‹ï¼ˆå¤§é¡ â†’ ç´°é …ï¼‰ =====
const CATEGORY_CASCADE = {
  categories: [
    { key: 'business', zh: 'å•†æ¥­', en: 'Business' },
    { key: 'tech', zh: 'ç§‘æŠ€', en: 'Technology' },
    { key: 'service', zh: 'æœå‹™', en: 'Service' },
    { key: 'finance', zh: 'é‡‘è', en: 'Finance' },
    { key: 'health', zh: 'å¥åº·/ä¿å¥', en: 'Health' },
    { key: 'education', zh: 'æ•™è‚²', en: 'Education' },
    { key: 'real-estate', zh: 'ä¸å‹•ç”¢', en: 'Real Estate' },
    { key: 'legal', zh: 'æ³•å¾‹', en: 'Legal' },
    { key: 'design', zh: 'è¨­è¨ˆ', en: 'Design' },
    { key: 'manufacturing', zh: 'è£½é€ ', en: 'Manufacturing' },
    { key: 'retail', zh: 'é›¶å”®', en: 'Retail' },
    { key: 'food', zh: 'é¤é£²', en: 'Food & Beverage' },
    { key: 'government', zh: 'æ”¿åºœ/éç‡Ÿåˆ©', en: 'Government / Non-profit' }
  ],
  subcategoriesByCategory: {
    'business': ['B2B å•†æ¥­', 'B2C å•†æ¥­', 'é›»å•†', 'è²¿æ˜“', 'æ‰¹ç™¼'],
    'tech': ['è»Ÿé«”é–‹ç™¼', 'ç¡¬é«”è£½é€ ', 'ç¶²è·¯æœå‹™', 'è³‡è¨Šå®‰å…¨', 'äººå·¥æ™ºæ…§'],
    'service': ['é¡§å•æœå‹™', 'å°ˆæ¥­æœå‹™', 'ç‰©æµæœå‹™', 'æ¸…æ½”æœå‹™', 'ä¿å…¨æœå‹™'],
    'finance': ['éŠ€è¡Œ', 'ä¿éšª', 'è­‰åˆ¸', 'æŠ•è³‡', 'æœƒè¨ˆ'],
    'health': ['é†«ç™‚', 'ä¿å¥', 'å¥èº«', 'ç¾å®¹', 'é¤Šç”Ÿ'],
    'education': ['å­¸æ ¡æ•™è‚²', 'è£œç¿’æ•™è‚²', 'è·æ¥­è¨“ç·´', 'ç·šä¸Šæ•™è‚²', 'èªè¨€æ•™è‚²'],
    'real-estate': ['ä¸å‹•ç”¢é–‹ç™¼', 'ä¸å‹•ç”¢ä»²ä»‹', 'ç‰©æ¥­ç®¡ç†', 'å®¤å…§è¨­è¨ˆ', 'è£æ½¢'],
    'legal': ['å¾‹å¸«äº‹å‹™æ‰€', 'æ³•å¾‹é¡§å•', 'å°ˆåˆ©äº‹å‹™', 'å…¬è­‰', 'èª¿è§£'],
    'design': ['å¹³é¢è¨­è¨ˆ', 'ç¶²é è¨­è¨ˆ', 'å·¥æ¥­è¨­è¨ˆ', 'ç©ºé–“è¨­è¨ˆ', 'å“ç‰Œè¨­è¨ˆ'],
    'manufacturing': ['é›»å­è£½é€ ', 'æ©Ÿæ¢°è£½é€ ', 'é£Ÿå“è£½é€ ', 'ç´¡ç¹”è£½é€ ', 'åŒ–å­¸è£½é€ '],
    'retail': ['ç™¾è²¨', 'è¶…å¸‚', 'ä¾¿åˆ©å•†åº—', 'å°ˆè³£åº—', 'ç¶²è·¯é›¶å”®'],
    'food': ['é¤å»³', 'å’–å•¡å»³', 'é£²æ–™åº—', 'å¤–é€', 'é£Ÿå“è£½é€ '],
    'government': ['æ”¿åºœæ©Ÿé—œ', 'å…¬ç‡Ÿäº‹æ¥­', 'éç‡Ÿåˆ©çµ„ç¹”', 'ç¤¾ç¦æ©Ÿæ§‹', 'ç ”ç©¶æ©Ÿæ§‹']
  }
};

// ===== å°ˆæ¥­é ˜åŸŸå…©å±¤å¼è³‡æ–™çµæ§‹ï¼ˆå¤§é¡ â†’ ç´°é …ï¼‰ =====
const FIELD_CASCADE = {
  categories: [
    { key: 'marketing-sales', zh: 'è¡ŒéŠ· / æ¥­å‹™', en: 'Marketing / Sales' },
    { key: 'tech', zh: 'è³‡è¨Šç§‘æŠ€', en: 'Information Technology' },
    { key: 'design-creative', zh: 'è¨­è¨ˆ / å‰µæ„', en: 'Design / Creative' },
    { key: 'healthcare', zh: 'é†«ç™‚ / é•·ç…§', en: 'Healthcare / Long-term Care' },
    { key: 'education-consulting', zh: 'æ•™è‚² / é¡§å•', en: 'Education / Consulting' },
    { key: 'food-service', zh: 'é¤é£² / æœå‹™', en: 'Food & Beverage / Service' },
    { key: 'operations', zh: 'ç‡Ÿé‹ / ç®¡ç†', en: 'Operations / Management' },
    { key: 'finance-accounting', zh: 'è²¡å‹™ / æœƒè¨ˆ', en: 'Finance / Accounting' },
    { key: 'hr', zh: 'äººè³‡', en: 'Human Resources' },
    { key: 'legal', zh: 'æ³•å‹™', en: 'Legal' },
    { key: 'customer-success', zh: 'å®¢æœ / å®¢æˆ¶æˆåŠŸ', en: 'Customer Success' },
    { key: 'product', zh: 'ç”¢å“', en: 'Product' }
  ],
  subcategoriesByCategory: {
    'marketing-sales': ['æ•¸ä½è¡ŒéŠ·', 'ç¤¾ç¾¤åª’é«”', 'å…§å®¹è¡ŒéŠ·', 'SEO/SEM', 'å»£å‘ŠæŠ•æ”¾', 'B2B æ¥­å‹™', 'B2C æ¥­å‹™', 'é›»å•†éŠ·å”®', 'é€šè·¯ç®¡ç†'],
    'tech': ['å‰ç«¯å·¥ç¨‹', 'å¾Œç«¯å·¥ç¨‹', 'å…¨ç«¯å·¥ç¨‹', 'DevOps', 'è³‡æ–™ç§‘å­¸', 'è¡Œå‹•é–‹ç™¼', 'è³‡è¨Šå®‰å…¨', 'é›²ç«¯æœå‹™'],
    'design-creative': ['UI/UX è¨­è¨ˆ', 'å¹³é¢è¨­è¨ˆ', 'ç¶²é è¨­è¨ˆ', 'å½±éŸ³è£½ä½œ', 'å‹•ç•«', 'å“ç‰Œè¨­è¨ˆ', 'åŒ…è£è¨­è¨ˆ'],
    'healthcare': ['é†«ç™‚', 'è­·ç†', 'é•·ç…§', 'å¾©å¥', 'è—¥å­¸', 'é†«æª¢', 'ç‡Ÿé¤Š'],
    'education-consulting': ['æ•™å­¸', 'åŸ¹è¨“', 'é¡§å•', 'æ•™ç·´', 'èª²ç¨‹è¨­è¨ˆ', 'æ•™æé–‹ç™¼'],
    'food-service': ['é¤å»³ç®¡ç†', 'å»šè—', 'æœå‹™ç”Ÿ', 'èª¿é…’å¸«', 'å’–å•¡å¸«', 'å¤–é€æœå‹™'],
    'operations': ['ç‡Ÿé‹ç®¡ç†', 'å°ˆæ¡ˆç®¡ç†', 'å“è³ªç®¡ç†', 'ä¾›æ‡‰éˆç®¡ç†', 'æµç¨‹å„ªåŒ–'],
    'finance-accounting': ['è²¡å‹™åˆ†æ', 'æœƒè¨ˆ', 'å¯©è¨ˆ', 'ç¨…å‹™', 'æŠ•è³‡åˆ†æ', 'é¢¨éšªç®¡ç†'],
    'hr': ['æ‹›å‹Ÿ', 'è¨“ç·´ç™¼å±•', 'è–ªé…¬ç¦åˆ©', 'å“¡å·¥é—œä¿‚', 'çµ„ç¹”ç™¼å±•'],
    'legal': ['æ³•å‹™', 'åˆç´„ç®¡ç†', 'æ™ºæ…§è²¡ç”¢', 'æ³•è¦éµå¾ª', 'è¨´è¨Ÿ'],
    'customer-success': ['å®¢æˆ¶æœå‹™', 'å®¢æˆ¶æˆåŠŸ', 'æŠ€è¡“æ”¯æ´', 'å¸³æˆ¶ç®¡ç†', 'é—œä¿‚ç¶­è­·'],
    'product': ['ç”¢å“ç®¡ç†', 'ç”¢å“è¨­è¨ˆ', 'ç”¢å“è¡ŒéŠ·', 'ç”¢å“åˆ†æ', 'ç”¢å“ç­–ç•¥']
  }
};

// å‘å¾Œå…¼å®¹ï¼šä¿ç•™ DIRECTORY_INDEXï¼ˆä½†ä¸å†ç”¨æ–¼é¸æ“‡å™¨ï¼‰
const DIRECTORY_INDEX = {
  categories: [],
  fields: []
};

// è‡ªè¨‚ç´¢å¼•ï¼ˆä½¿ç”¨è€…åœ¨ã€Œå…¶ä»–ã€è¼¸å…¥å¾Œæœƒè¨˜ä½ï¼‰
const CUSTOM_INDEX_KEY = 'directoryCustomIndex';

// ===== å…©å±¤å¼é¸æ“‡å™¨ï¼ˆé¡åˆ¥/å°ˆæ¥­é ˜åŸŸå…±ç”¨é‚è¼¯ï¼‰ =====
const TWO_LEVEL_PICKER = {
  isOpen: false,
  type: null, // 'category' | 'field'
  target: null, // 'filter' | 'friend'
  step: 'category', // 'category' | 'subcategory' | 'custom'
  temp: {
    categoryKey: '',
    categoryLabel: '',
    subcategoryKey: '',
    subcategoryLabel: ''
  }
};

function setTwoLevelPickerTitle() {
  const titleZh = document.getElementById('twoLevelPickerTitleZh');
  const titleEn = document.getElementById('twoLevelPickerTitleEn');
  if (!titleZh || !titleEn) return;
  const currentLang = getCurrentLang();
  
  if (TWO_LEVEL_PICKER.step === 'category') {
    if (TWO_LEVEL_PICKER.type === 'category') {
      titleZh.textContent = 'é¸æ“‡é¡åˆ¥';
      titleEn.textContent = 'Select Category';
    } else {
      titleZh.textContent = 'é¸æ“‡å°ˆæ¥­é ˜åŸŸ';
      titleEn.textContent = 'Select Professional Field';
    }
  } else if (TWO_LEVEL_PICKER.step === 'subcategory' || TWO_LEVEL_PICKER.step === 'custom') {
    titleZh.textContent = TWO_LEVEL_PICKER.temp.categoryLabel || 'é¸æ“‡ç´°é …';
    titleEn.textContent = TWO_LEVEL_PICKER.temp.categoryLabel || 'Select Subcategory';
  }
}

function setTwoLevelPickerBackVisibility() {
  const backBtn = document.getElementById('twoLevelPickerBackBtn');
  if (!backBtn) return;
  backBtn.style.visibility = (TWO_LEVEL_PICKER.step === 'category') ? 'hidden' : 'visible';
}

function openTwoLevelPicker(type, target) {
  const overlay = document.getElementById('twoLevelPickerOverlay');
  if (!overlay) return;
  TWO_LEVEL_PICKER.isOpen = true;
  TWO_LEVEL_PICKER.type = type;
  TWO_LEVEL_PICKER.target = target;
  TWO_LEVEL_PICKER.step = 'category';
  TWO_LEVEL_PICKER.temp = { categoryKey: '', categoryLabel: '', subcategoryKey: '', subcategoryLabel: '' };
  document.body.style.overflow = 'hidden';
  overlay.classList.add('show');
  renderTwoLevelPicker();
}

function closeTwoLevelPicker(event) {
  if (event && event.target && event.target.id !== 'twoLevelPickerOverlay') return;
  const overlay = document.getElementById('twoLevelPickerOverlay');
  if (!overlay) return;
  TWO_LEVEL_PICKER.isOpen = false;
  TWO_LEVEL_PICKER.type = null;
  TWO_LEVEL_PICKER.target = null;
  document.body.style.overflow = '';
  overlay.classList.remove('show');
  const custom = document.getElementById('twoLevelPickerCustom');
  const list = document.getElementById('twoLevelPickerList');
  if (custom) custom.classList.remove('show');
  if (list) list.classList.remove('hide');
}

function twoLevelPickerBack() {
  if (TWO_LEVEL_PICKER.step === 'subcategory' || TWO_LEVEL_PICKER.step === 'custom') {
    TWO_LEVEL_PICKER.step = 'category';
    TWO_LEVEL_PICKER.temp.subcategoryKey = '';
    TWO_LEVEL_PICKER.temp.subcategoryLabel = '';
  }
  renderTwoLevelPicker();
}

function twoLevelPickerCancelCustom() {
  TWO_LEVEL_PICKER.step = 'subcategory';
  renderTwoLevelPicker();
}

function twoLevelPickerConfirmCustom() {
  const input = document.getElementById('twoLevelPickerCustomInput');
  const label = String(input?.value || '').trim();
  if (!label) {
    const msg = getCurrentLang() === 'zh' ? 'è«‹è¼¸å…¥è‡ªè¨‚åç¨±' : 'Please enter a custom name';
    alert(msg);
    return;
  }
  TWO_LEVEL_PICKER.temp.subcategoryKey = 'custom';
  TWO_LEVEL_PICKER.temp.subcategoryLabel = label;
  applyTwoLevelPickerResult();
  closeTwoLevelPicker();
}

function renderTwoLevelPicker() {
  setTwoLevelPickerTitle();
  setTwoLevelPickerBackVisibility();

  const list = document.getElementById('twoLevelPickerList');
  const custom = document.getElementById('twoLevelPickerCustom');
  if (!list || !custom) return;

  if (TWO_LEVEL_PICKER.step === 'custom') {
    list.classList.add('hide');
    custom.classList.add('show');
    const input = document.getElementById('twoLevelPickerCustomInput');
    if (input) {
      input.value = '';
      setTimeout(() => input.focus(), 0);
    }
    return;
  }

  custom.classList.remove('show');
  list.classList.remove('hide');

  const currentLang = getCurrentLang();
  let items = [];
  const data = TWO_LEVEL_PICKER.type === 'category' ? CATEGORY_CASCADE : FIELD_CASCADE;

  if (TWO_LEVEL_PICKER.step === 'category') {
    items = data.categories.map(c => ({
      key: c.key,
      label: currentLang === 'zh' ? c.zh : c.en
    }));
  } else if (TWO_LEVEL_PICKER.step === 'subcategory') {
    const categoryKey = TWO_LEVEL_PICKER.temp.categoryKey;
    const subcategories = data.subcategoriesByCategory[categoryKey] || [];
    items = subcategories.map(s => ({ key: s, label: s }));
    // ç¬¬äºŒå±¤ï¼šæ·»åŠ ã€Œå…¶ä»–ã€é¸é …ï¼ˆå¯è‡ªè¨‚ï¼‰
    items.push({ key: 'other', label: 'å…¶ä»–' });
  }

  if (!items.length) {
    list.innerHTML = `
      <div class="region-picker-empty">
        <div class="lang-zh">æ­¤å±¤æ²’æœ‰å¯é¸é …ç›®</div>
        <div class="lang-en">No options available</div>
      </div>
    `;
    return;
  }

  list.innerHTML = items.map(it => `
    <button type="button" class="region-picker-item" onclick="twoLevelPickerSelect('${TWO_LEVEL_PICKER.step}','${String(it.key).replace(/'/g,"&#39;")}')">
      ${it.label}
    </button>
  `).join('');
}

function twoLevelPickerSelect(step, key) {
  const data = TWO_LEVEL_PICKER.type === 'category' ? CATEGORY_CASCADE : FIELD_CASCADE;
  
  if (step === 'category') {
    const category = data.categories.find(c => c.key === key);
    TWO_LEVEL_PICKER.temp.categoryKey = key;
    TWO_LEVEL_PICKER.temp.categoryLabel = category ? category.zh : key;
    TWO_LEVEL_PICKER.step = 'subcategory';
    renderTwoLevelPicker();
    return;
  }

  if (step === 'subcategory') {
    if (key === 'other') {
      TWO_LEVEL_PICKER.step = 'custom';
      renderTwoLevelPicker();
      return;
    }
    TWO_LEVEL_PICKER.temp.subcategoryKey = key;
    TWO_LEVEL_PICKER.temp.subcategoryLabel = key;
    applyTwoLevelPickerResult();
    closeTwoLevelPicker();
  }
}

function applyTwoLevelPickerResult() {
  const t = TWO_LEVEL_PICKER.target;
  const type = TWO_LEVEL_PICKER.type;
  if (!t || !type) return;
  
  const valueEl = document.getElementById(t === 'filter' 
    ? (type === 'category' ? 'filterCategory' : 'filterField')
    : (type === 'category' ? 'friendCategory' : 'friendField'));
  const displayEl = document.getElementById(t === 'filter'
    ? (type === 'category' ? 'filterCategoryDisplay' : 'filterFieldDisplay')
    : (type === 'category' ? 'friendCategoryDisplay' : 'friendFieldDisplay'));

  const parts = [];
  if (TWO_LEVEL_PICKER.temp.categoryLabel) parts.push(TWO_LEVEL_PICKER.temp.categoryLabel);
  if (TWO_LEVEL_PICKER.temp.subcategoryLabel) parts.push(TWO_LEVEL_PICKER.temp.subcategoryLabel);
  const displayText = parts.join(' / ');

  if (valueEl) valueEl.value = displayText;
  if (displayEl) displayEl.value = displayText;
}

// ===== åœ°å€ï¼ˆä¸‰ç´šè¯å‹•ï¼‰ï¼šå€åŸŸ â†’ ç¸£å¸‚ â†’ å€ =====
// è¨»ï¼šè‹±æ–‡å€åç‚ºç°¡åŒ–è™•ç†ï¼ˆåŒä¸­æ–‡ï¼‰ï¼Œå¯å¾ŒçºŒå†è£œæ­£è¦è‹±è­¯
const REGION_CASCADE = {
  zones: [
    { value: 'north', zh: 'åŒ—', en: 'North' },
    { value: 'central', zh: 'ä¸­', en: 'Central' },
    { value: 'south', zh: 'å—', en: 'South' },
    { value: 'east', zh: 'æ±', en: 'East' },
    { value: 'islands', zh: 'é›¢å³¶', en: 'Islands' },
    { value: 'overseas', zh: 'æµ·å¤–', en: 'Overseas' },
    { value: 'other', zh: 'å…¶ä»–', en: 'Other' }
  ],
  citiesByZone: {
    north: [
      { value: 'taipei', zh: 'å°åŒ—å¸‚', en: 'Taipei City' },
      { value: 'newtaipei', zh: 'æ–°åŒ—å¸‚', en: 'New Taipei City' },
      { value: 'keelung', zh: 'åŸºéš†å¸‚', en: 'Keelung City' },
      { value: 'taoyuan', zh: 'æ¡ƒåœ’å¸‚', en: 'Taoyuan City' },
      { value: 'hsinchu-city', zh: 'æ–°ç«¹å¸‚', en: 'Hsinchu City' },
      { value: 'hsinchu-county', zh: 'æ–°ç«¹ç¸£', en: 'Hsinchu County' },
      { value: 'yilan', zh: 'å®œè˜­ç¸£', en: 'Yilan County' }
    ],
    central: [
      { value: 'miaoli', zh: 'è‹—æ —ç¸£', en: 'Miaoli County' },
      { value: 'taichung', zh: 'å°ä¸­å¸‚', en: 'Taichung City' },
      { value: 'changhua', zh: 'å½°åŒ–ç¸£', en: 'Changhua County' },
      { value: 'nantou', zh: 'å—æŠ•ç¸£', en: 'Nantou County' },
      { value: 'yunlin', zh: 'é›²æ—ç¸£', en: 'Yunlin County' }
    ],
    south: [
      { value: 'chiayi-city', zh: 'å˜‰ç¾©å¸‚', en: 'Chiayi City' },
      { value: 'chiayi-county', zh: 'å˜‰ç¾©ç¸£', en: 'Chiayi County' },
      { value: 'tainan', zh: 'å°å—å¸‚', en: 'Tainan City' },
      { value: 'kaohsiung', zh: 'é«˜é›„å¸‚', en: 'Kaohsiung City' },
      { value: 'pingtung', zh: 'å±æ±ç¸£', en: 'Pingtung County' }
    ],
    east: [
      { value: 'hualien', zh: 'èŠ±è“®ç¸£', en: 'Hualien County' },
      { value: 'taitung', zh: 'å°æ±ç¸£', en: 'Taitung County' }
    ],
    islands: [
      { value: 'penghu', zh: 'æ¾æ¹–ç¸£', en: 'Penghu County' },
      { value: 'kinmen', zh: 'é‡‘é–€ç¸£', en: 'Kinmen County' },
      { value: 'matsu', zh: 'é€£æ±Ÿç¸£ï¼ˆé¦¬ç¥–ï¼‰', en: 'Lienchiang County (Matsu)' }
    ],
    overseas: [],
    other: []
  },
  districtsByCity: {
    taipei: ['ä¸­æ­£å€','å¤§åŒå€','ä¸­å±±å€','æ¾å±±å€','å¤§å®‰å€','è¬è¯å€','ä¿¡ç¾©å€','å£«æ—å€','åŒ—æŠ•å€','å…§æ¹–å€','å—æ¸¯å€','æ–‡å±±å€'],
    newtaipei: ['æ¿æ©‹å€','ä¸‰é‡å€','ä¸­å’Œå€','æ°¸å’Œå€','æ–°èŠå€','æ–°åº—å€','åœŸåŸå€','è˜†æ´²å€','æ±æ­¢å€','æ¨¹æ—å€','æ·¡æ°´å€','é¶¯æ­Œå€','ä¸‰å³½å€','ç‘èŠ³å€','äº”è‚¡å€','æ³°å±±å€','æ—å£å€','æ·±å‘å€','çŸ³ç¢‡å€','åªæ—å€','ä¸‰èŠå€','çŸ³é–€å€','å…«é‡Œå€','å¹³æºªå€','é›™æºªå€','è²¢å¯®å€','é‡‘å±±å€','è¬é‡Œå€','çƒä¾†å€'],
    keelung: ['ä»æ„›å€','ä¿¡ç¾©å€','ä¸­æ­£å€','ä¸­å±±å€','å®‰æ¨‚å€','æš–æš–å€','ä¸ƒå µå€'],
    taoyuan: ['æ¡ƒåœ’å€','ä¸­å£¢å€','å¹³é®å€','å…«å¾·å€','æ¥Šæ¢…å€','è˜†ç«¹å€','å¤§æºªå€','é¾æ½­å€','é¾œå±±å€','å¤§åœ’å€','è§€éŸ³å€','æ–°å±‹å€','å¾©èˆˆå€'],
    'hsinchu-city': ['æ±å€','åŒ—å€','é¦™å±±å€'],
    'hsinchu-county': ['ç«¹åŒ—å¸‚','ç«¹æ±é®','æ–°åŸ”é®','é—œè¥¿é®','æ¹–å£é„‰','æ–°è±é„‰','èŠæ—é„‰','æ©«å±±é„‰','åŒ—åŸ”é„‰','å¯¶å±±é„‰','å³¨çœ‰é„‰','å°–çŸ³é„‰','äº”å³°é„‰'],
    yilan: ['å®œè˜­å¸‚','ç¾…æ±é®','è˜‡æ¾³é®','é ­åŸé®','ç¤æºªé„‰','å£¯åœé„‰','å“¡å±±é„‰','å†¬å±±é„‰','äº”çµé„‰','ä¸‰æ˜Ÿé„‰','å¤§åŒé„‰','å—æ¾³é„‰'],
    miaoli: ['è‹—æ —å¸‚','é ­ä»½å¸‚','è‹‘è£¡é®','é€šéœ„é®','ç«¹å—é®','å¾Œé¾é®','å“è˜­é®','å¤§æ¹–é„‰','å…¬é¤¨é„‰','éŠ…é‘¼é„‰','å—åº„é„‰','é ­å±‹é„‰','ä¸‰ç¾©é„‰','è¥¿æ¹–é„‰','é€ æ©‹é„‰','ä¸‰ç£é„‰','ç…æ½­é„‰','æ³°å®‰é„‰'],
    taichung: ['ä¸­å€','æ±å€','å—å€','è¥¿å€','åŒ—å€','åŒ—å±¯å€','è¥¿å±¯å€','å—å±¯å€','å¤ªå¹³å€','å¤§é‡Œå€','éœ§å³°å€','çƒæ—¥å€','è±åŸå€','åé‡Œå€','çŸ³å²¡å€','æ±å‹¢å€','å’Œå¹³å€','æ–°ç¤¾å€','æ½­å­å€','å¤§é›…å€','ç¥å²¡å€','å¤§è‚šå€','æ²™é¹¿å€','é¾äº•å€','æ¢§æ£²å€','æ¸…æ°´å€','å¤§ç”²å€','å¤–åŸ”å€','å¤§å®‰å€'],
    changhua: ['å½°åŒ–å¸‚','å“¡æ—å¸‚','å’Œç¾é®','é¹¿æ¸¯é®','æºªæ¹–é®','ç”°ä¸­é®','åŒ—æ–—é®','äºŒæ—é®','ç·šè¥¿é„‰','ä¼¸æ¸¯é„‰','ç¦èˆˆé„‰','ç§€æ°´é„‰','èŠ±å£‡é„‰','èŠ¬åœ’é„‰','å¤§æ‘é„‰','åŸ”é¹½é„‰','åŸ”å¿ƒé„‰','æ°¸é–é„‰','ç¤¾é ­é„‰','äºŒæ°´é„‰','ç”°å°¾é„‰','åŸ¤é ­é„‰','èŠ³è‹‘é„‰','å¤§åŸé„‰','ç«¹å¡˜é„‰','æºªå·é„‰'],
    nantou: ['å—æŠ•å¸‚','åŸ”é‡Œé®','è‰å±¯é®','ç«¹å±±é®','é›†é›†é®','åé–“é„‰','é¹¿è°·é„‰','ä¸­å¯®é„‰','é­šæ± é„‰','åœ‹å§“é„‰','æ°´é‡Œé„‰','ä¿¡ç¾©é„‰','ä»æ„›é„‰'],
    yunlin: ['æ–—å…­å¸‚','æ–—å—é®','è™å°¾é®','è¥¿èºé®','åœŸåº«é®','åŒ—æ¸¯é®','å¤å‘é„‰','å¤§åŸ¤é„‰','è¿æ¡é„‰','æ—å…§é„‰','äºŒå´™é„‰','å´™èƒŒé„‰','éº¥å¯®é„‰','æ±å‹¢é„‰','è¤’å¿ é„‰','è‡ºè¥¿é„‰','å…ƒé•·é„‰','å››æ¹–é„‰','å£æ¹–é„‰','æ°´æ—é„‰'],
    'chiayi-city': ['æ±å€','è¥¿å€'],
    'chiayi-county': ['å¤ªä¿å¸‚','æœ´å­å¸‚','å¸ƒè¢‹é®','å¤§æ—é®','æ°‘é›„é„‰','æºªå£é„‰','æ–°æ¸¯é„‰','å…­è…³é„‰','æ±çŸ³é„‰','ç¾©ç«¹é„‰','é¹¿è‰é„‰','æ°´ä¸Šé„‰','ä¸­åŸ”é„‰','ç«¹å´é„‰','æ¢…å±±é„‰','ç•ªè·¯é„‰','å¤§åŸ”é„‰','é˜¿é‡Œå±±é„‰'],
    tainan: ['ä¸­è¥¿å€','æ±å€','å—å€','åŒ—å€','å®‰å¹³å€','å®‰å—å€','æ°¸åº·å€','æ­¸ä»å€','æ–°åŒ–å€','å·¦é®å€','ç‰äº•å€','æ¥ è¥¿å€','å—åŒ–å€','ä»å¾·å€','é—œå»Ÿå€','é¾å´å€','å®˜ç”°å€','éº»è±†å€','ä½³é‡Œå€','è¥¿æ¸¯å€','ä¸ƒè‚¡å€','å°‡è»å€','å­¸ç”²å€','åŒ—é–€å€','æ–°ç‡Ÿå€','å¾Œå£å€','ç™½æ²³å€','æ±å±±å€','å…­ç”²å€','ä¸‹ç‡Ÿå€','æŸ³ç‡Ÿå€','é¹½æ°´å€','å–„åŒ–å€','å¤§å…§å€','å±±ä¸Šå€','æ–°å¸‚å€','å®‰å®šå€'],
    kaohsiung: ['æ¥ æ¢“å€','å·¦ç‡Ÿå€','é¼“å±±å€','ä¸‰æ°‘å€','é¹½åŸ•å€','å‰é‡‘å€','æ–°èˆˆå€','è‹“é›…å€','å‰é®å€','å°æ¸¯å€','æ——æ´¥å€','é³³å±±å€','å¤§å¯®å€','é³¥æ¾å€','æ—åœ’å€','ä»æ­¦å€','å¤§æ¨¹å€','å²¡å±±å€','è·¯ç«¹å€','æ©‹é ­å€','æ¢“å®˜å€','å½Œé™€å€','æ°¸å®‰å€','ç‡•å·¢å€','ç”°å¯®å€','é˜¿è“®å€','èŒ„è£å€','æ¹–å…§å€','æ——å±±å€','ç¾æ¿ƒå€','å…§é–€å€','æ‰æ—å€','ç”²ä»™å€','å…­é¾œå€','èŒ‚æ—å€','æ¡ƒæºå€','é‚£ç‘ªå¤å€'],
    pingtung: ['å±æ±å¸‚','æ½®å·é®','æ±æ¸¯é®','æ†æ˜¥é®','è¬ä¸¹é„‰','é•·æ²»é„‰','éºŸæ´›é„‰','ä¹å¦‚é„‰','é‡Œæ¸¯é„‰','é¹½åŸ”é„‰','é«˜æ¨¹é„‰','è¬å·’é„‰','å…§åŸ”é„‰','ç«¹ç”°é„‰','æ–°åŸ¤é„‰','æ‹å¯®é„‰','æ–°åœ’é„‰','å´é ‚é„‰','æ—é‚Šé„‰','å—å·é„‰','ä½³å†¬é„‰','ç‰çƒé„‰','è»ŠåŸé„‰','æ»¿å·é„‰','æ‹å±±é„‰','ä¸‰åœ°é–€é„‰','éœ§è‡ºé„‰','ç‘ªå®¶é„‰','æ³°æ­¦é„‰','ä¾†ç¾©é„‰','æ˜¥æ—¥é„‰','ç…å­é„‰','ç‰¡ä¸¹é„‰'],
    hualien: ['èŠ±è“®å¸‚','é³³æ—é®','ç‰é‡Œé®','æ–°åŸé„‰','å‰å®‰é„‰','å£½è±é„‰','å…‰å¾©é„‰','è±æ¿±é„‰','ç‘ç©—é„‰','å¯Œé‡Œé„‰','ç§€æ—é„‰','è¬æ¦®é„‰','å“æºªé„‰'],
    taitung: ['è‡ºæ±å¸‚','æˆåŠŸé®','é—œå±±é®','å‘å—é„‰','é¹¿é‡é„‰','æ± ä¸Šé„‰','æ±æ²³é„‰','é•·æ¿±é„‰','å¤ªéº»é‡Œé„‰','å¤§æ­¦é„‰','ç¶ å³¶é„‰','è˜­å¶¼é„‰','å»¶å¹³é„‰','é‡‘å³°é„‰','é”ä»é„‰','æµ·ç«¯é„‰'],
    penghu: ['é¦¬å…¬å¸‚','æ¹–è¥¿é„‰','ç™½æ²™é„‰','è¥¿å¶¼é„‰','æœ›å®‰é„‰','ä¸ƒç¾é„‰'],
    kinmen: ['é‡‘åŸé®','é‡‘æ¹–é®','é‡‘æ²™é®','é‡‘å¯§é„‰','çƒˆå¶¼é„‰','çƒåµé„‰'],
    matsu: ['å—ç«¿é„‰','åŒ—ç«¿é„‰','è’å…‰é„‰','æ±å¼•é„‰']
  }
};

function safeSlug(input) {
  return String(input || '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/[^a-z0-9\-]/g, '')
    .slice(0, 60);
}

function addOptionsToSelect(selectEl, options) {
  options.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.value;
    option.setAttribute('data-lang-zh', opt.zh);
    option.setAttribute('data-lang-en', opt.en);
    // æ–‡å­—æœƒç”± common.js çš„ updateDirectorySelectOptions() ä¾èªè¨€è‡ªå‹•æ›´æ–°
    option.textContent = opt.zh;
    selectEl.appendChild(option);
  });
}

function getCustomIndex() {
  try {
    const raw = localStorage.getItem(CUSTOM_INDEX_KEY);
    const parsed = raw ? JSON.parse(raw) : {};
    return {
      categories: Array.isArray(parsed.categories) ? parsed.categories : [],
      regions: Array.isArray(parsed.regions) ? parsed.regions : [],
      fields: Array.isArray(parsed.fields) ? parsed.fields : [],
      // æ–°ç‰ˆåœ°å€ä¸‰ç´šè¯å‹•çš„è‡ªè¨‚é¸é …
      regionCities: Array.isArray(parsed.regionCities) ? parsed.regionCities : [],
      regionDistricts: Array.isArray(parsed.regionDistricts) ? parsed.regionDistricts : []
    };
  } catch (e) {
    return { categories: [], regions: [], fields: [], regionCities: [], regionDistricts: [] };
  }
}

function setCustomIndex(next) {
  try {
    localStorage.setItem(CUSTOM_INDEX_KEY, JSON.stringify(next));
  } catch (e) {}
}

function normalizeCustomLabel(zh, en) {
  const a = String(zh || '').trim();
  const b = String(en || '').trim();
  if (!a && !b) return null;
  return { zh: a || b, en: b || a };
}

function makeCustomValue(kind, labelZh) {
  const base = safeSlug(labelZh) || 'custom';
  return `custom-${kind}-${base}`;
}

function upsertCustomOption(kind, label) {
  const idx = getCustomIndex();
  const list = idx[kind] || [];
  const value = makeCustomValue(kind, label.zh);
  if (!list.some(o => o && o.value === value)) {
    list.push({ value, zh: label.zh, en: label.en });
  }
  idx[kind] = list;
  setCustomIndex(idx);
  return { value, zh: label.zh, en: label.en };
}

function insertOptionBeforeOther(selectEl, opt) {
  if (!selectEl || !opt) return;
  // é¿å…é‡è¤‡
  if (selectEl.querySelector(`option[value="${opt.value}"]`)) return;
  const el = document.createElement('option');
  el.value = opt.value;
  el.setAttribute('data-lang-zh', opt.zh);
  el.setAttribute('data-lang-en', opt.en);
  el.textContent = opt.zh;

  const otherOption = selectEl.querySelector('option[value="other"]');
  if (otherOption) {
    selectEl.insertBefore(el, otherOption);
  } else {
    selectEl.appendChild(el);
  }
}

function wireOtherToCustomTargets(selectEl, storageKind, targets, promptTitleZh, promptTitleEn, triggerValue = 'other') {
  if (!selectEl) return;
  selectEl.addEventListener('change', function() {
    if (selectEl.value !== triggerValue) return;

    const zhElements = document.querySelectorAll('.lang-zh');
    const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';

    const zhLabel = prompt(
      currentLang === 'zh'
        ? `è«‹è¼¸å…¥è‡ªè¨‚${promptTitleZh}ï¼ˆä¸­æ–‡ï¼‰ï¼š`
        : `Enter custom ${promptTitleEn} (Chinese label):`
    );
    const enLabel = prompt(
      currentLang === 'zh'
        ? `è«‹è¼¸å…¥è‡ªè¨‚${promptTitleZh}ï¼ˆè‹±æ–‡ï¼Œå¯ç•™ç©ºï¼‰ï¼š`
        : `Enter custom ${promptTitleEn} (English label, optional):`
    );

    const label = normalizeCustomLabel(zhLabel, enLabel);
    if (!label) {
      // å–æ¶ˆæˆ–ç©ºç™½ï¼šå›åˆ°æœªé¸
      selectEl.value = '';
      return;
    }

    const saved = upsertCustomOption(storageKind, label);

    // åŒæ­¥æ’å…¥ç›®æ¨™ selects
    (targets || []).forEach(sel => insertOptionBeforeOther(sel, saved));

    // é‡æ–°å¥—ç”¨èªè¨€æ–‡å­—
    if (typeof updateDirectorySelectOptions === 'function') updateDirectorySelectOptions();

    // é¸ä¸­è‡ªè¨‚é¸é …
    selectEl.value = saved.value;
  });
}

function wireOtherToCustom(selectEl, kind) {
  // å‘å¾Œå…¼å®¹ï¼šèˆŠçš„ã€Œé¡åˆ¥/å°ˆæ¥­é ˜åŸŸã€ä½¿ç”¨å›ºå®š targets
  if (!selectEl) return;
  if (kind === 'categories') {
    wireOtherToCustomTargets(selectEl, 'categories', [document.getElementById('filterCategory'), document.getElementById('friendCategory')], 'é¡åˆ¥', 'category');
  } else if (kind === 'fields') {
    wireOtherToCustomTargets(selectEl, 'fields', [document.getElementById('filterField'), document.getElementById('friendField')], 'å°ˆæ¥­é ˜åŸŸ', 'professional field');
  }
}

function initDirectoryIndexes() {
  // é¡åˆ¥å’Œå°ˆæ¥­é ˜åŸŸå·²æ”¹ç‚ºå…©å±¤å¼é¸æ“‡å™¨ï¼Œä¸å†éœ€è¦åˆå§‹åŒ– select
  // ä¿ç•™æ­¤å‡½æ•¸ä»¥å‚™å…¶ä»–ç´¢å¼•åˆå§‹åŒ–éœ€æ±‚
  
  refreshCompanyIndex();

  // è®“èªè¨€åˆ‡æ›ç«‹å³åæ˜ åˆ°æ–°åŠ å…¥çš„ option æ–‡å­—
  if (typeof updateDirectorySelectOptions === 'function') {
    updateDirectorySelectOptions();
  }
}

function resetSelect(selectEl, firstValue) {
  if (!selectEl) return;
  const first = selectEl.querySelector('option[value="' + (firstValue ?? '') + '"]');
  const keep = first ? first.outerHTML : '';
  selectEl.innerHTML = keep;
}

function addSimpleOptions(selectEl, opts, includeOther) {
  if (!selectEl) return;
  opts.forEach(opt => {
    const o = document.createElement('option');
    o.value = opt.value;
    o.setAttribute('data-lang-zh', opt.zh);
    o.setAttribute('data-lang-en', opt.en);
    o.textContent = opt.zh;
    selectEl.appendChild(o);
  });
  if (includeOther) {
    const other = document.createElement('option');
    other.value = 'other';
    other.setAttribute('data-lang-zh', 'å…¶ä»–');
    other.setAttribute('data-lang-en', 'Other');
    other.textContent = 'å…¶ä»–';
    selectEl.appendChild(other);
  }
}

function addDistrictOptions(selectEl, districts, includeOther) {
  if (!selectEl) return;
  districts.forEach(d => {
    const o = document.createElement('option');
    const v = safeSlug(d);
    o.value = v || d;
    o.setAttribute('data-lang-zh', d);
    o.setAttribute('data-lang-en', d);
    o.textContent = d;
    selectEl.appendChild(o);
  });
  if (includeOther) {
    const other = document.createElement('option');
    other.value = 'other';
    other.setAttribute('data-lang-zh', 'å…¶ä»–');
    other.setAttribute('data-lang-en', 'Other');
    other.textContent = 'å…¶ä»–';
    selectEl.appendChild(other);
  }
}

function addCustomTriggerOption(selectEl) {
  if (!selectEl) return;
  if (selectEl.querySelector('option[value="custom"]')) return;
  const opt = document.createElement('option');
  opt.value = 'custom';
  opt.setAttribute('data-lang-zh', 'è‡ªè¨‚â€¦');
  opt.setAttribute('data-lang-en', 'Customâ€¦');
  opt.textContent = 'è‡ªè¨‚â€¦';
  selectEl.appendChild(opt);
}

function initRegionCascade(zoneSel, citySel, distSel, opts) {
  if (!zoneSel || !citySel || !distSel) return;
  const allowOther = !!opts?.allowOther;

  // zone
  addSimpleOptions(zoneSel, REGION_CASCADE.zones.filter(z => z.value !== 'other'), allowOther);

  function rebuildCities() {
    const zone = zoneSel.value;
    // reset city & district
    resetSelect(citySel, '');
    resetSelect(distSel, '');

    if (!zone) {
      if (typeof updateDirectorySelectOptions === 'function') updateDirectorySelectOptions();
      return;
    }
    if (zone === 'overseas') {
      // overseasï¼šç›´æ¥è®“ç¸£å¸‚/å€ç¶­æŒç©ºç™½ï¼ˆå¯é¸å…¶ä»–è‡ªè¨‚ï¼‰
      if (allowOther) {
        addSimpleOptions(citySel, [], true);
        addSimpleOptions(distSel, [], true);
        addCustomTriggerOption(citySel);
        addCustomTriggerOption(distSel);
      }
      if (typeof updateDirectorySelectOptions === 'function') updateDirectorySelectOptions();
      return;
    }
    if (zone === 'other') {
      // è®“ citySel è§¸ç™¼ other è‡ªè¨‚
      if (allowOther) {
        addSimpleOptions(citySel, [], true);
        addCustomTriggerOption(citySel);
      }
      if (typeof updateDirectorySelectOptions === 'function') updateDirectorySelectOptions();
      return;
    }

    const cities = REGION_CASCADE.citiesByZone[zone] || [];
    addSimpleOptions(citySel, cities, allowOther);
    if (allowOther) addCustomTriggerOption(citySel);
    if (typeof updateDirectorySelectOptions === 'function') updateDirectorySelectOptions();
  }

  function rebuildDistricts() {
    const city = citySel.value;
    resetSelect(distSel, '');
    if (!city) {
      if (typeof updateDirectorySelectOptions === 'function') updateDirectorySelectOptions();
      return;
    }
    if (city === 'other' || city === 'custom') {
      // è‹¥ç¸£å¸‚ç‚ºã€Œå…¶ä»–ã€æˆ–ã€Œè‡ªè¨‚â€¦ã€ï¼Œå€å…ˆæä¾›å…¶ä»–èˆ‡è‡ªè¨‚â€¦
      if (allowOther) {
        addSimpleOptions(distSel, [], true);
        addCustomTriggerOption(distSel);
      }
      if (typeof updateDirectorySelectOptions === 'function') updateDirectorySelectOptions();
      return;
    }
    const districts = REGION_CASCADE.districtsByCity[city] || [];
    addDistrictOptions(distSel, districts, allowOther);
    if (allowOther) addCustomTriggerOption(distSel);
    if (typeof updateDirectorySelectOptions === 'function') updateDirectorySelectOptions();
  }

  zoneSel.addEventListener('change', rebuildCities);
  citySel.addEventListener('change', rebuildDistricts);

  // å…¶ä»–è‡ªè¨‚ï¼ˆç¸£å¸‚ / å€ï¼‰
  // è‡ªè¨‚é‚è¼¯å·²ç”± initDirectoryIndexes() ä»¥ targets æ–¹å¼çµ±ä¸€æ›è¼‰
}

function getStoredFriends() {
  try {
    const raw = localStorage.getItem('directoryFriends');
    const parsed = raw ? JSON.parse(raw) : [];
    return Array.isArray(parsed) ? parsed : [];
  } catch (e) {
    return [];
  }
}

function setStoredFriends(list) {
  try {
    localStorage.setItem('directoryFriends', JSON.stringify(list));
  } catch (e) {}
}

function refreshCompanyIndex() {
  const filterCompany = document.getElementById('filterCompany');
  if (!filterCompany) return;

  // æ¸…é™¤é™¤ç¬¬ä¸€å€‹ï¼ˆå…¨éƒ¨å…¬å¸ï¼‰ä»¥å¤–çš„ option
  const first = filterCompany.querySelector('option[value=""]');
  filterCompany.innerHTML = '';
  if (first) {
    filterCompany.appendChild(first);
  } else {
    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.setAttribute('data-lang-zh', 'å…¨éƒ¨å…¬å¸');
    allOpt.setAttribute('data-lang-en', 'All Companies');
    allOpt.textContent = 'å…¨éƒ¨å…¬å¸';
    filterCompany.appendChild(allOpt);
  }

  // åŸºç¤å…¬å¸ï¼ˆå¯æ“´å……ï¼‰
  const baseCompanies = [
    { key: 'uvaco', zh: 'UVACO', en: 'UVACO' },
    { key: 'puzhong', zh: 'è‘¡çœ¾ä¼æ¥­', en: 'Puzhong Enterprise' }
  ];

  const friends = getStoredFriends();
  const extraNames = friends
    .map(f => (f && f.company ? String(f.company).trim() : ''))
    .filter(Boolean);

  const uniq = new Map(); // key -> {zh,en}
  baseCompanies.forEach(c => uniq.set(c.key, { zh: c.zh, en: c.en }));
  extraNames.forEach(name => {
    const key = safeSlug(name) || name;
    if (!uniq.has(key)) {
      uniq.set(key, { zh: name, en: name });
    }
  });

  // æ’åºï¼šå…ˆ baseCompaniesï¼Œå†å…¶é¤˜ä¾ä¸­æ–‡/è‹±æ–‡åæ’åº
  const baseKeys = new Set(baseCompanies.map(c => c.key));
  const rest = Array.from(uniq.entries())
    .filter(([k]) => !baseKeys.has(k))
    .sort((a, b) => a[1].zh.localeCompare(b[1].zh, 'zh-Hant'));

  baseCompanies.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.key;
    opt.setAttribute('data-lang-zh', c.zh);
    opt.setAttribute('data-lang-en', c.en);
    opt.textContent = c.zh;
    filterCompany.appendChild(opt);
  });

  rest.forEach(([key, label]) => {
    const opt = document.createElement('option');
    opt.value = key;
    opt.setAttribute('data-lang-zh', label.zh);
    opt.setAttribute('data-lang-en', label.en);
    opt.textContent = label.zh;
    filterCompany.appendChild(opt);
  });

  if (typeof updateDirectorySelectOptions === 'function') {
    updateDirectorySelectOptions();
  }
}

// é¡¯ç¤ºæœå°‹é¸é …å½ˆå‡ºè¦–çª—
function showSearchOptions() {
  const options = document.getElementById('directorySearchOptions');
  options.classList.add('show');
}

// é—œé–‰æœå°‹é¸é …å½ˆå‡ºè¦–çª—
function closeSearchOptions() {
  const options = document.getElementById('directorySearchOptions');
  options.classList.remove('show');
}

// æ‰“é–‹é€²éšç¯©é¸
function openAdvancedFilter() {
  closeSearchOptions(); // é—œé–‰æœå°‹é¸é …å½ˆå‡ºè¦–çª—
  const panel = document.getElementById('directoryFilterPanel');
  
  // å¦‚æœé¢æ¿æœªæ‰“é–‹ï¼Œå‰‡æ‰“é–‹å®ƒ
  if (!panel.classList.contains('show')) {
    panel.classList.add('show');
  }
  
  // æ»¾å‹•åˆ°é€²éšç¯©é¸é¢æ¿
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// åˆ‡æ›é€²éšç¯©é¸é¢æ¿ï¼ˆä¿ç•™æ­¤å‡½æ•¸ä»¥å‚™ä¸æ™‚ä¹‹éœ€ï¼‰
function toggleDirectoryFilter() {
  const panel = document.getElementById('directoryFilterPanel');
  panel.classList.toggle('show');
}

// æ¸…é™¤ç¯©é¸æ¢ä»¶
function clearDirectoryFilters() {
  document.getElementById('filterCategory').value = '';
  const filterCategoryDisplay = document.getElementById('filterCategoryDisplay');
  if (filterCategoryDisplay) filterCategoryDisplay.value = '';
  document.getElementById('filterRegionZone').value = '';
  document.getElementById('filterRegionCity').value = '';
  document.getElementById('filterRegionDistrict').value = '';
  const filterRegionDisplay = document.getElementById('filterRegionDisplay');
  if (filterRegionDisplay) filterRegionDisplay.value = '';
  document.getElementById('filterField').value = '';
  const filterFieldDisplay = document.getElementById('filterFieldDisplay');
  if (filterFieldDisplay) filterFieldDisplay.value = '';
  document.getElementById('filterCompany').value = '';
  document.getElementById('directorySearchInput').value = '';
  searchDirectory();
  // é—œé–‰é€²éšé¢æ¿ï¼Œå›åˆ°é€šè¨ŠéŒ„
  closeAdvancedFilter();
}

// å¥—ç”¨ç¯©é¸æ¢ä»¶
function applyDirectoryFilters() {
  searchDirectory();
  // é—œé–‰é€²éšé¢æ¿ï¼Œå›åˆ°é€šè¨ŠéŒ„
  closeAdvancedFilter();
}

// é—œé–‰é€²éšç¯©é¸é¢æ¿
function closeAdvancedFilter() {
  const panel = document.getElementById('directoryFilterPanel');
  panel.classList.remove('show');
  closeSearchOptions();
  
  // æ»¾å‹•åˆ°çµæœå€åŸŸ
  const resultsHeader = document.querySelector('.directory-results-header');
  if (resultsHeader) {
    resultsHeader.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// æœå°‹è™•ç†
function handleDirectorySearch(event) {
  if (event.key === 'Enter' || event.type === 'keyup') {
    closeSearchOptions(); // é—œé–‰æœå°‹é¸é …
    searchDirectory();
  }
}

// åŸ·è¡Œæœå°‹
function searchDirectory() {
  // ç›®å‰å…ˆåšã€Œå…¨å¹³å°åç‰‡ã€çš„é—œéµå­—æœå°‹ï¼ˆname/company/titleï¼‰
  // é¡åˆ¥/åœ°å€/å°ˆæ¥­é ˜åŸŸ/å…¬å¸ç´¢å¼•å¯ä»¥å¾ŒçºŒå†æ¥åˆ° profile_jsonï¼ˆæˆ– directory_contactsï¼‰
  refreshDirectoryResults();
}

// æ›´æ–°æœå°‹çµæœ
function updateDirectoryResults(count) {
  document.getElementById('directoryResultsCount').textContent = count;
  document.getElementById('directoryResultsCountEn').textContent = count;
  
  const resultsDiv = document.getElementById('directoryResults');
  if (count === 0) {
    resultsDiv.innerHTML = `
      <div class="directory-empty-icon">ğŸ”</div>
      <div class="directory-empty-text lang-zh">
        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åç‰‡<br>
        è«‹å˜—è©¦èª¿æ•´æœå°‹é—œéµå­—æˆ–ç¯©é¸æ¢ä»¶
      </div>
      <div class="directory-empty-text lang-en">
        No business cards matching the criteria found.<br>
        Please try adjusting your search keywords or filters.
      </div>
    `;
    // æ›´æ–°èªè¨€é¡¯ç¤º
    const zhElements = document.querySelectorAll('.lang-zh');
    const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
    document.querySelectorAll('#directoryResults .lang-zh').forEach(el => {
      el.style.display = currentLang === 'zh' ? 'block' : 'none';
    });
    document.querySelectorAll('#directoryResults .lang-en').forEach(el => {
      el.style.display = currentLang === 'en' ? 'block' : 'none';
    });
  }
}

// é»æ“Šå¤–éƒ¨é—œé–‰æœå°‹é¸é …
document.addEventListener('click', function(event) {
  const searchInput = document.getElementById('directorySearchInput');
  const searchOptions = document.getElementById('directorySearchOptions');
  const filterPanel = document.getElementById('directoryFilterPanel');
  
  // å¦‚æœé»æ“Šçš„ä¸æ˜¯æœå°‹æ¡†ã€æœå°‹é¸é …æˆ–ç¯©é¸é¢æ¿ï¼Œå‰‡é—œé–‰é¸é …
  if (!searchInput.contains(event.target) && 
      !searchOptions.contains(event.target) && 
      !filterPanel.contains(event.target)) {
    closeSearchOptions();
  }
});

// ===== æ–°å¢å¥½å‹åŠŸèƒ½ =====

// æ‰“é–‹æ–°å¢å¥½å‹æ¨¡æ…‹æ¡†
function openAddFriendModal() {
  const overlay = document.getElementById('addFriendOverlay');
  overlay.classList.add('show');
  document.body.style.overflow = 'hidden';
  // é‡ç½®è¡¨å–®
  switchAddFriendTab('single');
}

// é—œé–‰æ–°å¢å¥½å‹æ¨¡æ…‹æ¡†
function closeAddFriendModal(event) {
  if (event && event.target.id !== 'addFriendOverlay') {
    return;
  }
  const overlay = document.getElementById('addFriendOverlay');
  overlay.classList.remove('show');
  document.body.style.overflow = '';
  // é‡ç½®è¡¨å–®
  document.querySelector('.add-friend-form').reset();
  document.getElementById('batchFileInput').value = '';
  document.getElementById('batchFileName').textContent = 'é¸æ“‡æª”æ¡ˆæˆ–æ‹–æ”¾è‡³æ­¤';
  document.getElementById('batchFileNameEn').textContent = 'Choose file or drag here';
  document.getElementById('batchUploadBtn').disabled = true;
  const friendRegionDisplay = document.getElementById('friendRegionDisplay');
  if (friendRegionDisplay) friendRegionDisplay.value = '';
}

// ===== åœ°å€ä¸‰å±¤å¼é¸æ“‡å™¨ï¼ˆModal/Bottom Sheetï¼‰=====
const REGION_PICKER = {
  isOpen: false,
  target: null, // 'filter' | 'friend'
  step: 'zone', // 'zone' | 'city' | 'district' | 'customZone'
  temp: {
    zoneKey: '',
    zoneLabel: '',
    cityKey: '',
    cityLabel: '',
    districtKey: '',
    districtLabel: ''
  }
};

function getZoneItemsForStep1() {
  // éœ€æ±‚ï¼šåªé¡¯ç¤ºäº”å€åŸŸ + è‡ªè¨‚â€¦
  return [
    { key: 'north', zh: 'åŒ—éƒ¨', en: 'North' },
    { key: 'central', zh: 'ä¸­éƒ¨', en: 'Central' },
    { key: 'south', zh: 'å—éƒ¨', en: 'South' },
    { key: 'east', zh: 'æ±éƒ¨', en: 'East' },
    { key: 'islands', zh: 'é›¢å³¶', en: 'Islands' },
    { key: 'custom', zh: 'è‡ªè¨‚â€¦', en: 'Customâ€¦', isCustom: true }
  ];
}

function getAllCitiesUnique() {
  const all = [];
  Object.keys(REGION_CASCADE.citiesByZone || {}).forEach(zone => {
    (REGION_CASCADE.citiesByZone[zone] || []).forEach(c => all.push(c));
  });
  const uniq = new Map(); // value -> item
  all.forEach(c => { if (c && c.value && !uniq.has(c.value)) uniq.set(c.value, c); });
  return Array.from(uniq.values());
}

function setRegionPickerTitle() {
  const titleZh = document.getElementById('regionPickerTitleZh');
  const titleEn = document.getElementById('regionPickerTitleEn');
  if (!titleZh || !titleEn) return;
  if (REGION_PICKER.step === 'zone') {
    titleZh.textContent = 'é¸æ“‡å€åŸŸ';
    titleEn.textContent = 'Select Area';
  } else if (REGION_PICKER.step === 'city') {
    titleZh.textContent = REGION_PICKER.temp.zoneLabel || 'é¸æ“‡ç¸£å¸‚';
    titleEn.textContent = REGION_PICKER.temp.zoneLabel || 'Select City/County';
  } else if (REGION_PICKER.step === 'district') {
    titleZh.textContent = REGION_PICKER.temp.cityLabel || 'é¸æ“‡å€/é„‰é®å¸‚';
    titleEn.textContent = REGION_PICKER.temp.cityLabel || 'Select District';
  } else if (REGION_PICKER.step === 'customZone') {
    titleZh.textContent = 'è‡ªè¨‚å€åŸŸ';
    titleEn.textContent = 'Custom Area';
  }
}

function setRegionPickerBackVisibility() {
  const backBtn = document.getElementById('regionPickerBackBtn');
  if (!backBtn) return;
  backBtn.style.visibility = (REGION_PICKER.step === 'zone') ? 'hidden' : 'visible';
}

function openRegionPicker(target) {
  const overlay = document.getElementById('regionPickerOverlay');
  if (!overlay) return;
  REGION_PICKER.isOpen = true;
  REGION_PICKER.target = target;
  REGION_PICKER.step = 'zone';
  REGION_PICKER.temp = { zoneKey:'', zoneLabel:'', cityKey:'', cityLabel:'', districtKey:'', districtLabel:'' };
  document.body.style.overflow = 'hidden';
  overlay.classList.add('show');
  renderRegionPicker();
}

function closeRegionPicker(event) {
  if (event && event.target && event.target.id !== 'regionPickerOverlay') return;
  const overlay = document.getElementById('regionPickerOverlay');
  if (!overlay) return;
  REGION_PICKER.isOpen = false;
  REGION_PICKER.target = null;
  document.body.style.overflow = '';
  overlay.classList.remove('show');
  const custom = document.getElementById('regionPickerCustom');
  const list = document.getElementById('regionPickerList');
  if (custom) custom.classList.remove('show');
  if (list) list.classList.remove('hide');
}

function regionPickerBack() {
  if (REGION_PICKER.step === 'district') {
    REGION_PICKER.step = 'city';
    REGION_PICKER.temp.districtKey = '';
    REGION_PICKER.temp.districtLabel = '';
  } else if (REGION_PICKER.step === 'city') {
    REGION_PICKER.step = 'zone';
    REGION_PICKER.temp.cityKey = '';
    REGION_PICKER.temp.cityLabel = '';
  } else if (REGION_PICKER.step === 'customZone') {
    REGION_PICKER.step = 'zone';
  }
  renderRegionPicker();
}

function regionPickerCancelCustom() {
  REGION_PICKER.step = 'zone';
  renderRegionPicker();
}

function regionPickerConfirmCustom() {
  const input = document.getElementById('regionPickerCustomInput');
  const label = String(input?.value || '').trim();
  if (!label) {
    const msg = getCurrentLang() === 'zh' ? 'è«‹è¼¸å…¥è‡ªè¨‚å€åŸŸåç¨±' : 'Please enter a custom area name';
    alert(msg);
    return;
  }
  REGION_PICKER.temp.zoneKey = 'custom';
  REGION_PICKER.temp.zoneLabel = label;
  REGION_PICKER.step = 'city';
  renderRegionPicker();
}

function renderRegionPicker() {
  setRegionPickerTitle();
  setRegionPickerBackVisibility();

  const list = document.getElementById('regionPickerList');
  const custom = document.getElementById('regionPickerCustom');
  if (!list || !custom) return;

  if (REGION_PICKER.step === 'customZone') {
    list.classList.add('hide');
    custom.classList.add('show');
    const input = document.getElementById('regionPickerCustomInput');
    if (input) {
      input.value = '';
      setTimeout(() => input.focus(), 0);
    }
    return;
  }

  custom.classList.remove('show');
  list.classList.remove('hide');

  const currentLang = getCurrentLang();
  let items = [];

  if (REGION_PICKER.step === 'zone') {
    items = getZoneItemsForStep1().map(z => ({
      key: z.key,
      label: currentLang === 'zh' ? z.zh : z.en
    }));
  } else if (REGION_PICKER.step === 'city') {
    const zoneKey = REGION_PICKER.temp.zoneKey;
    const cityItems = zoneKey === 'custom'
      ? getAllCitiesUnique()
      : (REGION_CASCADE.citiesByZone[zoneKey] || []);
    items = cityItems.map(c => ({
      key: c.value,
      label: currentLang === 'zh' ? c.zh : c.en
    }));
  } else if (REGION_PICKER.step === 'district') {
    const cityKey = REGION_PICKER.temp.cityKey;
    const districts = REGION_CASCADE.districtsByCity[cityKey] || [];
    items = districts.map(d => ({ key: d, label: d }));
  }

  if (!items.length) {
    list.innerHTML = `
      <div class="region-picker-empty">
        <div class="lang-zh">æ­¤å±¤æ²’æœ‰å¯é¸é …ç›®</div>
        <div class="lang-en">No options available</div>
      </div>
    `;
    return;
  }

  list.innerHTML = items.map(it => `
    <button type="button" class="region-picker-item" onclick="regionPickerSelect('${REGION_PICKER.step}','${String(it.key).replace(/'/g,"&#39;")}')">
      ${it.label}
    </button>
  `).join('');
}

function regionPickerSelect(step, key) {
  if (step === 'zone') {
    if (key === 'custom') {
      REGION_PICKER.step = 'customZone';
      renderRegionPicker();
      return;
    }
    const zone = getZoneItemsForStep1().find(z => z.key === key);
    REGION_PICKER.temp.zoneKey = key;
    REGION_PICKER.temp.zoneLabel = zone ? zone.zh : key;
    REGION_PICKER.step = 'city';
    renderRegionPicker();
    return;
  }

  if (step === 'city') {
    const zoneKey = REGION_PICKER.temp.zoneKey;
    const cities = zoneKey === 'custom' ? getAllCitiesUnique() : (REGION_CASCADE.citiesByZone[zoneKey] || []);
    const city = cities.find(c => c.value === key);
    REGION_PICKER.temp.cityKey = key;
    REGION_PICKER.temp.cityLabel = city ? city.zh : key;
    REGION_PICKER.step = 'district';
    renderRegionPicker();
    return;
  }

  if (step === 'district') {
    REGION_PICKER.temp.districtKey = key;
    REGION_PICKER.temp.districtLabel = key;
    applyRegionPickerResult();
    closeRegionPicker();
  }
}

function applyRegionPickerResult() {
  const t = REGION_PICKER.target;
  if (!t) return;
  const zoneEl = document.getElementById(t === 'filter' ? 'filterRegionZone' : 'friendRegionZone');
  const cityEl = document.getElementById(t === 'filter' ? 'filterRegionCity' : 'friendRegionCity');
  const distEl = document.getElementById(t === 'filter' ? 'filterRegionDistrict' : 'friendRegionDistrict');
  const displayEl = document.getElementById(t === 'filter' ? 'filterRegionDisplay' : 'friendRegionDisplay');

  if (zoneEl) zoneEl.value = REGION_PICKER.temp.zoneLabel || '';
  if (cityEl) cityEl.value = REGION_PICKER.temp.cityLabel || '';
  if (distEl) distEl.value = REGION_PICKER.temp.districtLabel || '';

  const displayText = [REGION_PICKER.temp.zoneLabel, REGION_PICKER.temp.cityLabel, REGION_PICKER.temp.districtLabel]
    .filter(Boolean)
    .join(' / ');
  if (displayEl) displayEl.value = displayText;
}

// åˆ‡æ›æ–°å¢å¥½å‹æ¨™ç±¤é 
function switchAddFriendTab(tab) {
  // æ›´æ–°æ¨™ç±¤æŒ‰éˆ•ç‹€æ…‹
  document.querySelectorAll('.add-friend-tab').forEach(btn => btn.classList.remove('active'));
  if (tab === 'single') {
    document.getElementById('tabSingle').classList.add('active');
  } else {
    document.getElementById('tabBatch').classList.add('active');
  }
  
  // æ›´æ–°å…§å®¹å€åŸŸ
  document.querySelectorAll('.add-friend-tab-content').forEach(content => content.classList.remove('active'));
  if (tab === 'single') {
    document.getElementById('tabContentSingle').classList.add('active');
  } else {
    document.getElementById('tabContentBatch').classList.add('active');
  }
}

// æäº¤å–®ç­†æ–°å¢
function submitSingleFriend(event) {
  event.preventDefault();
  
  const friendData = {
    name: document.getElementById('friendName').value,
    company: document.getElementById('friendCompany').value,
    position: document.getElementById('friendPosition').value,
    phone: document.getElementById('friendPhone').value,
    email: document.getElementById('friendEmail').value,
    category: document.getElementById('friendCategory')?.value || '',
    categoryDisplay: document.getElementById('friendCategoryDisplay')?.value || '',
    regionZone: document.getElementById('friendRegionZone')?.value || '',
    regionCity: document.getElementById('friendRegionCity')?.value || '',
    regionDistrict: document.getElementById('friendRegionDistrict')?.value || '',
    field: (document.getElementById('friendField')?.value || ''),
    fieldDisplay: (document.getElementById('friendFieldDisplay')?.value || '')
  };

  // å­˜åˆ° localStorageï¼Œä½œç‚ºã€Œå…¬å¸ç´¢å¼•ã€èˆ‡å¾ŒçºŒé€šè¨ŠéŒ„è³‡æ–™ä¾†æº
  const friends = getStoredFriends();
  friends.push({
    ...friendData,
    createdAt: Date.now()
  });
  setStoredFriends(friends);
  refreshCompanyIndex();
  
  // é€™è£¡å¯ä»¥é€£æ¥å¯¦éš›çš„ API
  console.log('æ–°å¢å¥½å‹:', friendData);
  
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  const msg = currentLang === 'zh' ? 'å¥½å‹å·²æ–°å¢ï¼' : 'Friend added successfully!';
  alert(msg);
  
  // é—œé–‰æ¨¡æ…‹æ¡†
  closeAddFriendModal();
  
  // åˆ·æ–°æœå°‹çµæœ
  searchDirectory();
}

// ä¸‹è¼‰ç¯„ä¾‹æª”æ¡ˆ
function downloadSampleFile(event) {
  event.preventDefault();
  
  // å‰µå»ºç¯„ä¾‹ Excel æ•¸æ“š
  const sampleData = [
    ['å§“å', 'å…¬å¸', 'è·å‹™', 'é›»è©±', 'Email', 'é¡åˆ¥', 'åœ°å€', 'å°ˆæ¥­é ˜åŸŸ'],
    ['å¼µä¸‰', 'UVACO', 'æ¥­å‹™ç¶“ç†', '0912345678', 'zhang@example.com', 'å•†æ¥­', 'å°åŒ—å¸‚', 'æ¥­å‹™/éŠ·å”®'],
    ['æå››', 'è‘¡çœ¾ä¼æ¥­', 'è¡ŒéŠ·å°ˆå“¡', '0923456789', 'li@example.com', 'æœå‹™', 'æ–°åŒ—å¸‚', 'è¡ŒéŠ·/å“ç‰Œ']
  ];
  
  // è½‰æ›ç‚º CSV æ ¼å¼ï¼ˆç°¡åŒ–ç‰ˆï¼Œå¯¦éš›æ‡‰è©²ä½¿ç”¨ Excel åº«ï¼‰
  const csvContent = sampleData.map(row => row.join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', 'è¯çµ¡äººåŒ¯å…¥ç¯„ä¾‹.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  const msg = currentLang === 'zh' ? 'ç¯„ä¾‹æª”æ¡ˆå·²ä¸‹è¼‰' : 'Sample file downloaded';
  // alert(msg);
}

// è™•ç†æ‰¹é‡æª”æ¡ˆé¸æ“‡
function handleBatchFileSelect(event) {
  const file = event.target.files[0];
  if (file) {
    const fileName = file.name;
    document.getElementById('batchFileName').textContent = fileName;
    document.getElementById('batchFileNameEn').textContent = fileName;
    document.getElementById('batchUploadBtn').disabled = false;
  } else {
    document.getElementById('batchFileName').textContent = 'é¸æ“‡æª”æ¡ˆæˆ–æ‹–æ”¾è‡³æ­¤';
    document.getElementById('batchFileNameEn').textContent = 'Choose file or drag here';
    document.getElementById('batchUploadBtn').disabled = true;
  }
}

// æäº¤æ‰¹é‡ä¸Šå‚³
function submitBatchUpload() {
  const fileInput = document.getElementById('batchFileInput');
  const file = fileInput.files[0];
  
  if (!file) {
    const zhElements = document.querySelectorAll('.lang-zh');
    const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
    const msg = currentLang === 'zh' ? 'è«‹é¸æ“‡æª”æ¡ˆ' : 'Please select a file';
    alert(msg);
    return;
  }
  
  // é€™è£¡å¯ä»¥é€£æ¥å¯¦éš›çš„ API ä¸Šå‚³æª”æ¡ˆ
  console.log('ä¸Šå‚³æª”æ¡ˆ:', file.name);
  
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  const msg = currentLang === 'zh' ? 'æª”æ¡ˆä¸Šå‚³æˆåŠŸï¼' : 'File uploaded successfully!';
  alert(msg);
  
  // é—œé–‰æ¨¡æ…‹æ¡†
  closeAddFriendModal();
  
  // åˆ·æ–°æœå°‹çµæœ
  searchDirectory();
}

// åˆå§‹åŒ–ï¼ˆç¢ºä¿åœ¨ common.js initLangAndTheme å¾Œä¹ŸæœƒæŠŠ option æ–‡å­—åˆ‡åˆ°æ­£ç¢ºèªè¨€ï¼‰
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initDirectoryIndexes, 0);
  });
} else {
  setTimeout(initDirectoryIndexes, 0);
}
</script>

</body>
</html>

